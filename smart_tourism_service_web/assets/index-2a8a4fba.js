import{s as oe,J as ie,d as ee,c as V,o,b as r,v as w,x as F,aI as G,aJ as Q,g as e,F as L,q as J,e as x,a as c,M as W,r as $,u as re,aK as ue,E as de,l as ce,p as fe,w as D,y as pe,aL as ve,aM as ge,B as me,O as H,C as xe,R as we,T as be,az as Z,aN as he,t as z,av as _e,af as ye,K as ke,aF as Ce,aO as Ne,z as Te,D as Se}from"./index-1b86b595.js";function $e(u){return oe({url:"/workflow/public/search",method:"get",params:u})}async function De(u){return Ue("/api/workflow/run",{options:u.options,signal:u.signal,startCallback:u.startCallback||(()=>{}),messageReceived:u.messageReceived||(()=>{}),thinkingDataReceived:u.thinkingDataReceived||(()=>{}),doneCallback:u.doneCallback||(()=>{}),errorCallback:u.errorCallback||(()=>{})})}async function Ue(u,l){var U;try{const f=ie(),C=f.token?`Bearer ${f.token}`:"";console.log("SSE 请求配置:",{url:u,token:C?"已设置":"未设置",options:l.options});const h=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json",Authorization:C,"Accept-Language":"zh_CN","Content-Language":"zh_CN",clientId:"web"},body:JSON.stringify({...l.options}),signal:l.signal});console.log("SSE 响应状态:",{status:h.status,statusText:h.statusText,contentType:h.headers.get("content-type"),ok:h.ok});const K=h.headers.get("content-type")||"";if(!h.ok||!K.includes("text/event-stream"))throw new Error(`SSE open failed: ${h.status} ${h.statusText}`);const s=(U=h.body)==null?void 0:U.getReader();if(!s)throw new Error("ReadableStream not supported");const p=new TextDecoder("utf-8");let a="";for(;;){const{done:b,value:v}=await s.read();if(b)break;a+=p.decode(v,{stream:!0});const N=a.split(`

`);a=N.pop()||"";for(const R of N){const O=R.split(`
`);let k="";const P=[];for(const A of O)A.startsWith("event:")?k=A.slice(6).trim():A.startsWith("data:")&&P.push(A.slice(5));let E=P.join(`
`);if(E.indexOf("-_wrap_-")===0&&(E=E.replace("-_wrap_-",`
`)),k==="[START]"){l.startCallback(E);continue}if(k==="[ERROR]"){l.errorCallback(E);continue}if(k==="[DONE]"){l.doneCallback(E);continue}if(k==="[AUDIO]"){l.audioDataReceived&&l.audioDataReceived(E);continue}if(k==="[THINKING]"){l.thinkingDataReceived&&l.thinkingDataReceived(E);continue}if(k==="[STATE_CHANGED]"){l.stateChanged&&l.stateChanged(E);continue}l.messageReceived(E,k)}}}catch(f){throw l.errorCallback((f==null?void 0:f.message)||String(f)),f}}const Ee="/assets/workflow-dbdbd0bd.svg",Re={key:0,class:"py-2 text-red-500"},Ie={key:1,class:"text-center py-2 text-neutral-400"},Oe=["title","name"],Me={class:"flex items-center space-x-2 bg-gray-100 px-2 py-1 rounded-md"},je={class:"text-base"},ze={class:"flex flex-col space-y-2"},Ae={class:"min-w-24 pr-2"},Pe={key:0,class:"flex"},Be={class:"whitespace-pre-wrap break-words"},Le={key:0,class:"flex flex-wrap gap-2"},Ke=["src","alt","onClick"],qe={class:"min-w-24 pr-2"},Je={class:"whitespace-pre-wrap break-words"},We=ee({__name:"RuntimeNodes",props:{nodes:{},workflow:{},errorMsg:{},token:{}},setup(u){const l=u,U=V(()=>{var p;const s=(((p=l.workflow)==null?void 0:p.nodes)||[]).find(a=>{var b;return((b=a.wfComponent)==null?void 0:b.name)==="Start"});return((s==null?void 0:s.nodeConfig)||{}).prologue||""});function f(s){return!s.includes("http")&&!s.includes("/api")?`/api${s}`:s}function C(s){var p,a;return(s==null?void 0:s.workflowComponentId)??(s==null?void 0:s.wfComponentId)??((p=s==null?void 0:s.wfComponent)==null?void 0:p.id)??((a=s==null?void 0:s.wfComponent)==null?void 0:a.componentId)}function h(s){switch(String(s||"")){case"1":return"carbon:play-outline";case"2":return"carbon:closed-caption";case"3":return"carbon:question-answering";case"4":return"solar:pallete-2-linear";case"5":return"carbon:ibm-knowledge-catalog-standard";case"6":return"carbon:api-key";case"7":return"carbon:connect-target";case"8":return"oui:logstash-if";case"9":return"carbon:type-pattern";case"10":return"carbon:prompt-template";case"11":return"ri:google-line";case"14":return"covid:transmission-virus-human-transmit-2";case"15":return"carbon:mail-all";case"16":return"carbon:http";default:return"ri:information-line"}}function K(s){const p=window.open("","_blank","width=800,height=600,scrollbars=yes,resizable=yes");p&&(p.document.write(`
      <html>
        <head>
          <title>图片预览</title>
          <style>
            body { 
              margin: 0; 
              padding: 20px; 
              background: #f5f5f5; 
              display: flex; 
              justify-content: center; 
              align-items: center; 
              min-height: 100vh;
            }
            img { 
              max-width: 100%; 
              max-height: 100%; 
              border-radius: 8px; 
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
          </style>
        </head>
        <body>
          <img src="${s}" alt="预览图片" />
        </body>
      </html>
    `),p.document.close())}return(s,p)=>(o(),r("div",null,[u.errorMsg?(o(),r("div",Re,"错误："+w(u.errorMsg),1)):u.nodes.length===0?(o(),r("div",Ie,"无内容")):F("",!0),G(e("div",{class:"p-2"},w(U.value),513),[[Q,U.value]]),(o(!0),r(L,null,J(u.nodes,a=>(o(),r("div",{key:a.uuid,class:"flex flex-col space-y-2 border border-gray-200 p-2 m-2 rounded-md",title:a.nodeTitle,name:a.uuid},[e("div",Me,[x(c(W),{icon:h(C(a)),class:"text-base"},null,8,["icon"]),e("div",je,w(a.nodeTitle||"找不到节点标题"),1)]),e("div",ze,[p[0]||(p[0]=e("div",{class:"text-base border-b border-gray-200 py-1"},"输入",-1)),(o(!0),r(L,null,J(a.input,(b,v)=>(o(),r("div",{key:`input_${v}`,class:"flex"},[e("div",Ae,w(v),1),e("div",null,w(b.value||"无内容"),1)]))),128)),p[1]||(p[1]=e("div",{class:"text-base border-b border-gray-200 py-1"},"输出",-1)),a.chunks?(o(),r("div",Pe,[e("div",Be,w(a.chunks),1)])):(o(!0),r(L,{key:1},J(a.output,(b,v)=>(o(),r("div",{key:`onput_${v}`,class:"flex"},[b.type===4?(o(),r("div",Le,[(o(!0),r(L,null,J(Array.isArray(b.value)?b.value:[b.value],N=>(o(),r("div",{key:String(N),class:"relative"},[e("img",{src:`${f(String(N))}?token=${u.token||""}`,alt:String(v),class:"w-24 h-24 object-cover rounded border border-gray-200 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>K(`${f(String(N))}?token=${u.token||""}`)},null,8,Ke)]))),128))])):(o(),r(L,{key:1},[e("div",qe,w(v),1),e("div",Je,w(b.value||"无内容"),1)],64))]))),128))])],8,Oe))),128))]))}}),He={class:"h-full flex"},Ve={class:"h-full flex flex-col workflow-sider"},Fe={class:"px-2 pb-2"},Ge={key:0,class:"space-y-2"},Qe=["onClick"],Xe={class:"flex items-start gap-2"},Ye=["src"],Ze={class:"flex-1 min-w-0"},et={class:"flex items-center justify-between gap-2"},tt={class:"font-medium text-[13px] truncate"},st={class:"flex-1 h-full flex flex-col bg-white dark:bg-white"},at={class:"flex items-center justify-between px-4 h-[56px] border-b border-neutral-200 bg-white dark:bg-white"},nt={class:"font-medium text-neutral-800 truncate max-w-[70%]"},lt={class:"flex-1 bg-white dark:bg-white overflow-auto"},ot={class:"w-full max-w-[1100px] mx-auto px-6 py-10 h-full text-neutral-800"},it={key:0},rt={class:"w-full max-w-screen-xl m-auto z-10"},ut={class:"max-h-[65vh] overflow-y-auto mb-2"},dt={class:"sticky bottom-0 left-0 flex justify-center"},ct={key:0,class:"text-center text-neutral-400 py-8"},ft={key:1,class:"text-center text-neutral-600 py-8"},pt={key:1,class:"text-neutral-400 select-none flex items-center justify-center h-full"},vt={class:"px-6 bg-white dark:bg-white"},gt={class:"w-full max-w-[1100px] mx-auto pt-6 pb-10"},mt={class:"flex items-end gap-3"},xt={class:"space-y-3"},wt={class:"grid grid-cols-2 gap-2"},bt={class:"text-[13px]"},ht={class:"text-[13px]"},_t={class:"text-[13px]"},yt={class:"text-[13px]"},kt={class:"grid grid-cols-2 gap-2"},Ct={class:"text-[13px]"},Nt={class:"text-[13px]"},Tt=ee({__name:"index",setup(u){const l=$([]),U=$(null),f=$(""),C=$(!1),h=$(!1),{isMobile:K}=re(),s=$(!1),p=V(()=>{var n,t;return(n=B.value)!=null&&n.title||(t=B.value)!=null&&t.name?String(B.value.title||B.value.name):"工作流"}),a=$(!1),b=$(""),v=ue([]),N=$(""),R=$(!1),O=$({name:"runtimes",defaultTab:"流程执行详情",tab:"流程执行详情 ↓"}),k=de();let P=new AbortController;function E(n){n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),!C.value&&f.value.trim()&&Y())}const A=$(!1),M=$(null);function te(n){M.value=n,A.value=!0}const B=V(()=>l.value.find(n=>String(n.id)===String(U.value)));function se(n){U.value=n.id,v.splice(0,v.length),N.value="",R.value=!1,b.value="",a.value=!1}let X=!1;async function ae(){var n;if(!(h.value||X)){h.value=!0;try{const t=await $e({currentPage:1,pageSize:20});(n=t==null?void 0:t.data)!=null&&n.records?(l.value=t.data.records.map(d=>({id:d.id,name:d.name,title:d.title,desc:d.remark,remark:d.remark,uuid:d.uuid,isPublic:d.isPublic,userId:d.userId,userUuid:d.userUuid,userName:d.userName,nodes:d.nodes,edges:d.edges,createTime:d.createTime,updateTime:d.updateTime,isDeleted:d.isDeleted})),l.value.length>0&&(U.value=l.value[0].id)):(l.value=[{id:1,name:"示例工作流1",title:"示例工作流1",desc:"这是一个示例工作流",uuid:"example-uuid-1",nodes:[{inputConfig:{userInputs:[{uuid:"input-uuid-1",name:"var_user_input",title:"用户输入",type:1,required:!1}]}}]},{id:2,name:"示例工作流2",title:"示例工作流2",desc:"这是另一个示例工作流",uuid:"example-uuid-2",nodes:[{inputConfig:{userInputs:[{uuid:"input-uuid-2",name:"var_user_input",title:"用户输入",type:1,required:!1}]}}]}],U.value=l.value[0].id),X=!0}catch(t){console.error("加载工作流列表失败:",t)}finally{h.value=!1}}}async function Y(){var m;if(!U.value||!f.value.trim())return;const n=B.value;if(!n||!n.uuid||a.value)return;const t=n.nodes&&n.nodes.length>0?n.nodes[0]:null,d=((m=t==null?void 0:t.inputConfig)==null?void 0:m.user_inputs)||[];console.log("node0",t),console.log("uis",d);const q=d.map(g=>({uuid:g.uuid,name:g.name,content:{title:g.title,value:f.value,type:g.type},required:g.required}));a.value=!0,C.value=!0,R.value=!0,O.value.tab=R.value?`${O.value.defaultTab} ↓`:`${O.value.defaultTab} ↑`,P=new AbortController;try{b.value="";const g=new Map;v.splice(0,v.length),N.value="",await De({options:{uuid:n.uuid,inputs:q},signal:P.signal,startCallback:i=>{if(!i){k.error("启动失败");return}const j=JSON.parse(i);j.input={},q.forEach(_=>{j.input[_.name]={..._.content}}),b.value=j.uuid,console.log("工作流启动成功:",j)},thinkingDataReceived:i=>{console.log("Thinking data received:",i)},messageReceived:(i,j)=>{const _=j||"";try{if(_.includes("[NODE_RUN_")){const T=_.replace("[NODE_RUN_","").replace("]",""),I=JSON.parse(i);g.set(T,I.uuid);const y=((n==null?void 0:n.nodes)||[]).find(S=>S.uuid===T);y&&(I.nodeTitle=y.title,I.wfComponent=y.wfComponent),v.push(I)}else if(_.includes("[NODE_CHUNK_")){console.log("NODE_CHUNK_",_,i);const T=_.replace("[NODE_CHUNK_","").replace("]",""),I=g.get(T)||"",y=v.find(S=>S.uuid===I);y&&(y.chunks=(y.chunks||"")+i)}else if(_.includes("[NODE_INPUT_")){const T=_.replace("[NODE_INPUT_","").replace("]",""),I=g.get(T)||"",y=v.find(S=>S.uuid===I);if(y){const S=JSON.parse(i);y.input={...y.input,[S.name]:S.content}}}else if(_.includes("[NODE_OUTPUT_")){const T=_.replace("[NODE_OUTPUT_","").replace("]",""),I=g.get(T)||"",y=v.find(S=>S.uuid===I);if(y){const S=JSON.parse(i);y.output={...y.output,[S.name]:S.content}}}}catch(T){console.error("处理消息时出错:",T)}},doneCallback:i=>{Te(()=>{a.value=!1,C.value=!1,N.value="",k.success("执行成功"),console.log("工作流执行完成:",i)})},errorCallback:i=>{a.value=!1,C.value=!1,k.error(`系统提示：${i}`),N.value=i||"",console.error("工作流执行错误:",i)}})}catch(g){const i=(g==null?void 0:g.message)??"执行出错";k.error(i),a.value=!1,C.value=!1,N.value=i}f.value=""}function ne(){a.value&&(P.abort(),a.value=!1,C.value=!1,k.info("已停止执行"))}function le(){R.value=!R.value,O.value.tab=R.value?`${O.value.defaultTab} ↓`:`${O.value.defaultTab} ↑`}return ce(ae),fe(()=>{a.value&&P.abort()}),(n,t)=>{var d,q;return o(),r(L,null,[e("div",He,[x(c(Ce),{"has-sider":"",class:"h-full w-full"},{default:D(()=>[x(c(ve),{bordered:"",collapsed:s.value,"collapsed-width":0,width:220,"show-trigger":c(K)?!1:"arrow-circle","collapse-mode":"transform",onUpdateCollapsed:t[0]||(t[0]=m=>s.value=m)},{default:D(()=>[e("div",Ve,[x(c(ge),{class:"flex-1",trigger:"none"},{default:D(()=>[e("div",Fe,[t[3]||(t[3]=e("div",{class:"flex justify-center mb-3 mt-2"},[e("div",{class:"wf-title-chip"},"工作流")],-1)),l.value.length?(o(),r("div",Ge,[(o(!0),r(L,null,J(l.value,m=>(o(),r("div",{key:m.id,class:me(["wf-card",[U.value===m.id?"ring-1 ring-[#1677ff33] bg-[#f7fbff]":""]]),onClick:g=>se(m)},[e("div",Xe,[e("img",{src:c(Ee),alt:"workflow",width:"18",height:"18",class:"mt-[2px]"},null,8,Ye),e("div",Ze,[e("div",et,[e("div",tt,w(m.title||m.name),1),x(c(H),{text:"",size:"small",onClick:xe(g=>te(m),["stop"])},{default:D(()=>[x(c(W),{icon:"ri:information-line"})]),_:1},8,["onClick"])])])])],10,Qe))),128))])):(o(),we(c(be),{key:1,description:"暂无工作流"}))])]),_:1})])]),_:1},8,["collapsed","show-trigger"]),e("div",st,[t[7]||(t[7]=e("div",{class:"workflow-divider"},null,-1)),e("div",at,[e("div",nt,w(p.value),1)]),e("div",lt,[e("div",ot,[B.value?(o(),r("div",it,[e("div",rt,[x(c(Z),{type:"line","justify-content":"space-evenly",animated:"","default-value":"runtimes"},{default:D(()=>[x(c(he),{name:"runtimes",onClick:le},{default:D(()=>[z(w(O.value.tab),1)]),_:1})]),_:1}),x(c(Z),{type:"line","justify-content":"space-evenly",animated:""},{default:D(()=>[x(c(_e),{name:"runtimes","display-directive":"show","tab-props":{style:"display:none"}},{default:D(()=>[x(ye,{name:"collapse"},{default:D(()=>[G(e("div",ut,[x(We,{nodes:v,workflow:B.value,"error-msg":N.value,token:""},null,8,["nodes","workflow","error-msg"]),e("div",dt,[G(x(c(H),{size:"tiny",onClick:ne},{icon:D(()=>[x(c(W),{icon:"ri:stop-circle-line"})]),default:D(()=>[t[4]||(t[4]=z(" 停止请求 ",-1))]),_:1},512),[[Q,a.value]])])],512),[[Q,R.value]])]),_:1})]),_:1})]),_:1}),!R.value&&!a.value?(o(),r("div",ct," 请点击下方提交按钮开始执行工作流 ")):F("",!0),a.value&&v.length===0?(o(),r("div",ft,[...t[5]||(t[5]=[e("div",{class:"flex items-center justify-center gap-2"},[e("div",{class:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),z(" 工作流执行中... ")],-1)])])):F("",!0)])])):(o(),r("div",pt,"请选择一个工作流"))])]),e("div",vt,[e("div",gt,[t[6]||(t[6]=e("div",{class:"h-[1px] bg-neutral-200 mb-6"},null,-1)),e("div",mt,[x(c(ke),{value:f.value,"onUpdate:value":t[1]||(t[1]=m=>f.value=m),type:"textarea",autosize:{minRows:1,maxRows:6},placeholder:"请输入内容，Enter 提交，Shift + Enter 换行",clearable:"",onKeydown:E},null,8,["value"]),x(c(H),{type:"primary",loading:C.value,disabled:!f.value.trim()||C.value,circle:"",onClick:Y},{icon:D(()=>[x(c(W),{icon:"ri:send-plane-fill"})]),_:1},8,["loading","disabled"])])])])])]),_:1})]),x(c(Ne),{show:A.value,"onUpdate:show":t[2]||(t[2]=m=>A.value=m),preset:"card",title:((d=M.value)==null?void 0:d.title)||((q=M.value)==null?void 0:q.name)||"工作流详情",style:pe({width:c(K)?"90vw":"700px"}),"mask-closable":!0},{default:D(()=>{var m,g,i,j,_,T;return[e("div",xt,[e("div",wt,[e("div",null,[t[8]||(t[8]=e("span",{class:"text-[14px] text-neutral-600"},"标题:",-1)),t[9]||(t[9]=z()),e("span",bt,w((m=M.value)==null?void 0:m.title),1)]),e("div",null,[t[10]||(t[10]=e("span",{class:"text-[14px] text-neutral-600"},"UUID:",-1)),t[11]||(t[11]=z()),e("span",ht,w((g=M.value)==null?void 0:g.uuid),1)]),e("div",null,[t[12]||(t[12]=e("span",{class:"text-[14px] text-neutral-600"},"备注:",-1)),t[13]||(t[13]=z()),e("span",_t,w(((i=M.value)==null?void 0:i.remark)||"无"),1)]),e("div",null,[t[14]||(t[14]=e("span",{class:"text-[14px] text-neutral-600"},"公开:",-1)),t[15]||(t[15]=z()),e("span",yt,w((j=M.value)!=null&&j.isPublic?"是":"否"),1)])]),e("div",kt,[e("div",null,[t[16]||(t[16]=e("span",{class:"text-[14px] text-neutral-600"},"创建时间:",-1)),t[17]||(t[17]=z()),e("span",Ct,w((_=M.value)==null?void 0:_.createTime),1)]),e("div",null,[t[18]||(t[18]=e("span",{class:"text-[14px] text-neutral-600"},"更新时间:",-1)),t[19]||(t[19]=z()),e("span",Nt,w((T=M.value)==null?void 0:T.updateTime),1)])])])]}),_:1},8,["show","title","style"])],64)}}});const $t=Se(Tt,[["__scopeId","data-v-21c8299c"]]);export{$t as default};

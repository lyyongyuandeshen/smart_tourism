import{s as D,r as p,d as rt,i as at,h as ut,j as q,k as ct,l as dt,n as ft,p as pt,o as h,b as _,e as W,g as a,F as K,q as X,a as T,t as m,v as L,x as $,y as yt,z as vt,A as ht,B as _t,C as St,D as It}from"./index-1b86b595.js";import{C as bt}from"./index-ab3e4e84.js";function wt(o){return D({url:"/api/chat/public/sessions",method:"get",params:{page:(o==null?void 0:o.page)??1,page_size:(o==null?void 0:o.page_size)??10,...(o==null?void 0:o.status)!==void 0&&{status:o.status}}})}function At(o){return D({url:`/api/chat/public/sessions/${o}/join`,method:"post"})}function xt(o,s){return D({url:`/api/chat/public/sessions/${o}/messages`,method:"get",params:{page:(s==null?void 0:s.page)??1,page_size:(s==null?void 0:s.page_size)??50}})}function gt(o,s){return D({url:`/api/chat/public/sessions/${o}/reply`,method:"post",data:s})}function kt(o){return D({url:"/agent/proxy",method:"post",data:{action:"sync_run_app_workflow",body:{AppKey:o.AppKey,InputData:o.InputData,UserID:o.UserID,NoDebug:o.NoDebug!==void 0?o.NoDebug:!0},config_name:"e_support"}})}function Tt(){const o=p(!1),s=p(null),S=p("");return{isGenerating:o,smartReply:s,checkAndGenerateReply:async C=>{if(!C||C.length===0)return;const x=C[C.length-1];if(!x.isUser&&x.content!==S.value&&x.content.trim())try{o.value=!0,S.value=x.content;const g={}.VITE_APP_API_KEY||"d4e0j8svv9onn7j6sdhg",u=await kt({AppKey:g,InputData:JSON.stringify({UserInput:x.content}),UserID:"default",NoDebug:!0});if(console.log("å·¥ä½œæµæ‰§è¡Œå®Œæˆ:",u),u.status==="failed"){console.error("å·¥ä½œæµæ‰§è¡Œå¤±è´¥:",u.msg||u.message),s.value=null;return}let O="",b="",k=[];if(u.output&&u.output!=="null")try{const y=JSON.parse(u.output);if(y.Output2)try{const i=typeof y.Output2=="string"?JSON.parse(y.Output2):y.Output2;O=i.æƒ…ç»ª||i.emotion||i.mood||"",b=i.æ„å›¾||i.intent||""}catch(i){console.warn("è§£æž Output2 å¤±è´¥:",i)}if(y.output1){const i=y.output1;if(typeof i=="string")try{const c=JSON.parse(i),w=c.å›žå¤??c.replies;if(Array.isArray(w))k=w;else if(typeof w=="string"){const N=w.replace(/\\n/g,`
`),U=N.match(/\d+\.\s*[^\n]+/g);U&&U.length?k=U.map(j=>j.trim()):N.trim()&&(k=[N.trim()])}}catch(c){console.warn("è§£æž output1 å¤±è´¥(ä½œä¸ºçº¦å®š JSON):",c)}else if(typeof i=="object"){const c=i,w=c.å›žå¤??c.replies;Array.isArray(w)&&(k=w)}}}catch(y){console.warn("è§£æžå·¥ä½œæµ output å¤±è´¥:",y)}if(!k.length){s.value=null;return}s.value={emotion:O||"ä¸­æ€§",intent:b||"",replies:k}}catch(g){console.error("ç”Ÿæˆæ™ºèƒ½å›žå¤å¤±è´¥:",g),s.value=null}finally{o.value=!1}},clearReply:()=>{s.value=null},reset:()=>{o.value=!1,s.value=null,S.value=""}}}const Ct={class:"h-full w-full flex"},Mt={class:"chat-container"},Nt={class:"avatar"},Pt=["onContextmenu"],Ut={key:0},Rt={key:0,class:"smart-reply-dialog"},Lt={class:"smart-reply-header"},Dt={class:"smart-reply-highlight"},Ot={class:"smart-reply-highlight"},Et={class:"smart-reply-list"},zt=["onClick"],Vt={key:2,class:"smart-reply-indicator w-full px-6 py-2"},Bt={class:"p-6"},$t=3e4,jt=5e3,Gt=rt({__name:"index",setup(o){const s=p([]),S=p(""),A=p(!1),P=p(),I=p({visible:!1,x:0,y:0,messageIndex:-1,message:null}),C=p([]),x=p(!1),g=p(!1),u=at(),{isGenerating:O,smartReply:b,checkAndGenerateReply:k,clearReply:y}=Tt();ut.setMyData({local:"Chat"});let i,c;const w=t=>{let e=0;for(let n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return Math.abs(e)||Date.now()},N=async t=>{try{x.value=!0;const e=await wt(t);console.log("å…¬å¼€ä¼šè¯åˆ—è¡¨:",e);const n=Array.isArray(e==null?void 0:e.items)?e.items:[];C.value=n;const r=n.map((l,f)=>{const M=l.id??l.session_id??l.sessionId??`public-${f}`,V=l.session_id??l.sessionId??l.id??`public-${f}`;return{uuid:typeof M=="number"?M:w(String(M)),title:l.user_name||l.title||l.sessionTitle||l.latest_message||`ä¼šè¯ ${f+1}`,isEdit:!1,status:l.status,updateTime:l.update_time||l.updateTime||l.latest_message_time||l.updateTimeStr,sessionId:String(V)}}),d=r.map(l=>({uuid:l.uuid,data:[]}));u.$patch(l=>{var f;l.history=r,l.chat=d,l.active=((f=r[0])==null?void 0:f.uuid)??null})}catch(e){console.error("èŽ·å–ä¼šè¯åˆ—è¡¨å¤±è´¥:",e),C.value=[]}finally{x.value=!1}},U=()=>{i||(i=window.setInterval(()=>{N()},$t))},j=()=>{i&&(clearInterval(i),i=void 0)},Q=t=>{var e;return Array.isArray(t==null?void 0:t.items)?t.items:Array.isArray((e=t==null?void 0:t.data)==null?void 0:e.items)?t.data.items:Array.isArray(t==null?void 0:t.data)?t.data:Array.isArray(t)?t:[]},Z=t=>{const e=(t==null?void 0:t.content)??(t==null?void 0:t.message)??(t==null?void 0:t.text)??(t==null?void 0:t.latest_message)??"";if(!e)return null;const n=(t==null?void 0:t.sender_type)??(t==null?void 0:t.senderType)??(t==null?void 0:t.role)??(t==null?void 0:t.from)??(t==null?void 0:t.author_type)??"",r=(t==null?void 0:t.sender_name)??(t==null?void 0:t.senderName)??"",d=(t==null?void 0:t.message_type)??(t==null?void 0:t.messageType)??"",l=typeof n=="string"?n.toLowerCase():"",f=typeof r=="string"?r.toLowerCase():"",M=typeof d=="string"?d.toLowerCase():"",V=["user","visitor","customer","human"],B=["agent","assistant","admin","system","staff","service","support"],R=(H,lt)=>!!H&&lt.some(it=>H.includes(it));let v;return typeof(t==null?void 0:t.is_user)=="boolean"?v=!!t.is_user:typeof(t==null?void 0:t.isUser)=="boolean"&&(v=t.isUser),typeof v>"u"&&(R(l,V)?v=!1:R(l,B)||R(M,B)||R(f,B)?v=!0:(R(f,V),v=!1)),{content:e,isUser:v}};let E=0;const F=async t=>{const{joinSession:e=!1}=t??{},n=u.history.find(d=>d.uuid===u.active);if(!(n!=null&&n.sessionId)){s.value=[];return}const r=++E;g.value=!0;try{e&&await At(n.sessionId)}catch(d){console.error("æŽ¥å…¥ä¼šè¯å¤±è´¥:",d)}try{const d=await xt(n.sessionId),f=Q(d).map(Z).filter(M=>!!M);r===E&&(s.value=f,await z())}catch(d){console.error("èŽ·å–ä¼šè¯æ¶ˆæ¯å¤±è´¥:",d),r===E&&(s.value=[])}finally{r===E&&(g.value=!1)}},tt=()=>{G();const t=u.history.find(e=>e.uuid===u.active);t!=null&&t.sessionId&&(c=window.setInterval(()=>{F()},jt))},G=()=>{c&&(clearInterval(c),c=void 0)};q(()=>u.active,async()=>{G(),await F({joinSession:!0}),tt()},{immediate:!0}),q(()=>s.value,t=>{t&&t.length>0&&k(t)},{deep:!0});const et=t=>{S.value=t},nt=(t,e,n)=>{I.value={visible:!0,x:t.clientX,y:t.clientY,messageIndex:n,message:e}},ot=()=>{var t;console.log("æ–‡å­—è½¬è¯­éŸ³:",(t=I.value.message)==null?void 0:t.content),I.value.visible=!1},Y=()=>{I.value.visible&&(I.value.visible=!1)},z=async()=>{await vt(),P.value&&(P.value.scrollTop=P.value.scrollHeight)},st=async()=>{const t=S.value.trim();if(!t||A.value||g.value)return;const e=u.history.find(n=>n.uuid===u.active);if(!(e!=null&&e.sessionId)){console.error("æœªæ‰¾åˆ°å½“å‰ä¼šè¯ID");return}A.value=!0;try{await gt(e.sessionId,{content:t});const n={content:t,isUser:!0};s.value.push(n),S.value="",y(),await z()}catch(n){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",n);const r={content:"å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚",isUser:!0};s.value.push(r),await z()}finally{A.value=!1}},J=()=>{j(),G(),i&&(clearInterval(i),i=void 0),c&&(clearInterval(c),c=void 0)};return ct(()=>{J()}),dt(async()=>{await N({page:1,page_size:10,status:null}),U(),z(),document.addEventListener("click",Y)}),ft(()=>{J(),document.removeEventListener("click",Y)}),pt(()=>{J()}),(t,e)=>(h(),_("div",Ct,[W(ht),a("div",Mt,[a("div",{class:"chat-history",ref_key:"chatHistoryRef",ref:P},[(h(!0),_(K,null,X(s.value,(n,r)=>(h(),_("div",{key:r,class:_t(["chat-item",{"user-message":n.isUser,"bot-message":!n.isUser,loading:!n.isUser&&A.value&&r===s.value.length-1}])},[a("div",Nt,L(n.isUser?"ðŸ¤–":"ðŸ‘¤"),1),a("div",{class:"message-content",onContextmenu:St(d=>nt(d,n,r),["prevent"])},[n.content||!n.isUser&&!A.value||r!==s.value.length-1?(h(),_("p",Ut,L(n.content),1)):!n.isUser&&A.value&&r===s.value.length-1?(h(),_(K,{key:1},[e[1]||(e[1]=a("span",null,null,-1)),e[2]||(e[2]=a("span",null,null,-1)),e[3]||(e[3]=a("span",null,null,-1))],64)):$("",!0)],40,Pt)],2))),128))],512),T(b)&&T(b).replies&&T(b).replies.length?(h(),_("div",Rt,[a("div",Lt,[e[4]||(e[4]=m(" æ£€æµ‹åˆ°ç”¨æˆ·å½“å‰æƒ…ç»ªä¸º ",-1)),a("span",Dt,L(T(b).emotion),1),e[5]||(e[5]=m(" ï¼Œæ„å›¾ä¸º ",-1)),a("span",Ot,L(T(b).intent),1),e[6]||(e[6]=m(" ï¼Œæ‚¨å¯é‡‡ç”¨å¦‚ä¸‹å¿«æ·å›žå¤åº”ç­”ï¼š ",-1))]),a("div",Et,[(h(!0),_(K,null,X(T(b).replies,(n,r)=>(h(),_("button",{key:r,type:"button",class:"smart-reply-item",onClick:d=>et(n)},L(n),9,zt))),128))])])):$("",!0),I.value.visible?(h(),_("div",{key:1,class:"context-menu",style:yt({top:I.value.y+"px",left:I.value.x+"px"}),onClick:ot},[...e[7]||(e[7]=[a("div",{class:"context-menu-item"},"ðŸ”Š æ–‡å­—è½¬è¯­éŸ³",-1)])],4)):$("",!0),T(O)?(h(),_("div",Vt,[...e[8]||(e[8]=[a("span",{class:"loading-dot"},null,-1),a("span",{class:"loading-dot"},null,-1),a("span",{class:"loading-dot"},null,-1),a("span",{class:"indicator-text"},"æ­£åœ¨ç”Ÿæˆæ™ºèƒ½å›žå¤...",-1)])])):$("",!0),a("div",Bt,[W(T(bt),{modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=n=>S.value=n),placeholder:"è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...",onSendMessage:st,disabled:A.value||g.value,isCustomer:!1,isSos:!1},null,8,["modelValue","disabled"])])])]))}});const mt=It(Gt,[["__scopeId","data-v-1851c948"]]);export{mt as default};

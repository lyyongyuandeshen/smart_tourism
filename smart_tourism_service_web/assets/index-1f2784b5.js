import{d as N,o as _,b as h,g as n,s as x,bP as z,bQ as D,bN as F,bR as M,E as T,aK as R,r as w,l as j,e as a,w as r,a as o,bS as k,t as g,v as p,x as C,K as $,bT as v,O,aP as G,bU as H,D as K}from"./index-9ac666b4.js";import{P as Q,L as A}from"./PersonOutline-e0cd4aed.js";import{L as J}from"./LockClosedOutline-1387cf67.js";const W={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},X=N({name:"LogoGoogle",render:function(m,u){return _(),h("svg",W,u[0]||(u[0]=[n("path",{d:"M473.16 221.48l-2.26-9.59H262.46v88.22H387c-12.93 61.4-72.93 93.72-121.94 93.72c-35.66 0-73.25-15-98.13-39.11a140.08 140.08 0 0 1-41.8-98.88c0-37.16 16.7-74.33 41-98.78s61-38.13 97.49-38.13c41.79 0 71.74 22.19 82.94 32.31l62.69-62.36C390.86 72.72 340.34 32 261.6 32c-60.75 0-119 23.27-161.58 65.71C58 139.5 36.25 199.93 36.25 256s20.58 113.48 61.3 155.6c43.51 44.92 105.13 68.4 168.58 68.4c57.73 0 112.45-22.62 151.45-63.66c38.34-40.4 58.17-96.3 58.17-154.9c0-24.67-2.48-39.32-2.59-39.96z",fill:"currentColor"},null,-1)]))}});function Y(f){return x({url:"/v1/sso/auth-url",method:"get",params:{callback_url:f}})}function Z(f){return x({url:"/v1/sso/login",method:"post",data:f})}function L(){return x({url:"/v1/sso/config",method:"get"})}const ee={class:"login-container"},se={class:"login-content"},oe={class:"form-wrapper"},ae={class:"form-content"},te={class:"input-group"},ne={class:"input-label-row"},re={key:0,class:"error-message"},le={class:"input-group"},ie={class:"input-label-row"},ce={key:0,class:"error-message"},ue={class:"additional-links"},de={class:"action-buttons"},ge={class:"sso-login-section"},pe=N({__name:"index",setup(f){const{t:m}=z(),u=D(),U=F(),P=M(),l=T(),d=R({username:"",password:""}),S=w(!1),y=w(!1),b=w(!1),c=w(null),i=R({username:"",password:""});function I(){let s=!0;return d.username?i.username="":(i.username=m("login.usernameRequired"),s=!1),d.password?i.password="":(i.password=m("login.passwordRequired"),s=!1),s}async function V(s){if(I())try{S.value=!0,await u.userLogin(d),l.success(m("login.loginSuccess")),U.push("/")}catch(e){l.error(e.message||m("login.loginFailed"))}finally{S.value=!1}}async function q(){try{if(y.value=!0,!c.value){const e=await L();if((e.success||e.code===200)&&e.data)c.value=e.data;else{l.error(e.message||e.msg||"获取SSO配置失败");return}}const s=`${window.location.origin}/#/login`;try{const e=await Y(s);(e.success||e.code===200)&&e.data?e.data.auth_url?window.location.href=e.data.auth_url:typeof e.data=="string"?window.location.href=e.data:l.error("授权URL格式错误"):l.error(e.message||e.msg||"获取授权URL失败")}catch(e){console.error("获取授权URL失败，尝试直接跳转:",e),window.location.href=`${c.value.auth_url}/redirect?callback_url=${encodeURIComponent(s)}`}}catch(s){console.error("SSO登录错误:",s),l.error(s.message||"SSO登录失败")}finally{y.value=!1}}async function B(s){try{if(b.value=!0,!c.value){const t=await L();if((t.success||t.code===200)&&t.data)c.value=t.data;else{l.error(t.message||t.msg||"获取SSO配置失败");return}}const e=await Z({code:s,client_id:c.value.client_id,client_secret:c.value.client_secret||"b5hjzmqc62u0wx861q89t8mcjvh9f5gu"});if((e.success||e.code===200)&&e.data){e.access_token&&(localStorage.setItem("token",e.access_token),await u.userQrLogin(e.access_token)),e.data.user_info&&(u.updateUserInfo(e.data.user_info),u.recordState()),l.success("登录成功");const t=`${window.location.origin}${window.location.pathname}#/`;window.history.replaceState(null,"",t),U.replace("/")}else l.error(e.message||e.msg||"SSO登录失败")}catch(e){console.error("SSO登录错误:",e),l.error(e.message||e.msg||"SSO登录失败")}finally{b.value=!1}}function E(s){return new URLSearchParams(window.location.search).get(s)||P.query[s]||null}return j(async()=>{const s=E("code");if(s)console.log("检测到 SSO 回调，授权码:",s),await B(s);else try{const e=await L();(e.success||e.code===200)&&e.data&&(c.value=e.data)}catch(e){console.error("加载SSO配置失败:",e)}}),(s,e)=>(_(),h("div",ee,[a(o(H),{show:b.value},{default:r(()=>[n("div",se,[n("div",oe,[e[4]||(e[4]=n("div",{class:"login-methods"},[n("div",{class:"active-method"},"账号密码登录")],-1)),n("div",ae,[n("div",te,[n("div",ne,[a(o(k),{strong:"",class:"input-label"},{default:r(()=>[g(p(s.$t("login.username")),1)]),_:1}),i.username?(_(),h("div",re,p(i.username),1)):C("",!0)]),a(o($),{value:d.username,"onUpdate:value":e[0]||(e[0]=t=>d.username=t),placeholder:s.$t("login.enterEmailOrPhone"),round:"",clearable:"",class:"custom-input",status:i.username?"error":void 0},{prefix:r(()=>[a(o(v),{component:o(Q)},null,8,["component"])]),_:1},8,["value","placeholder","status"])]),n("div",le,[n("div",ie,[a(o(k),{strong:"",class:"input-label"},{default:r(()=>[g(p(s.$t("login.password")),1)]),_:1}),i.password?(_(),h("div",ce,p(i.password),1)):C("",!0)]),a(o($),{value:d.password,"onUpdate:value":e[1]||(e[1]=t=>d.password=t),type:"password",placeholder:s.$t("login.enterPassword"),round:"","show-password-on":"click",class:"custom-input",status:i.password?"error":void 0},{prefix:r(()=>[a(o(v),{component:o(J)},null,8,["component"])]),_:1},8,["value","placeholder","status"])]),n("div",ue,[a(o(O),{text:"",tag:"a",href:"#/resetpassword",class:"forgot-password"},{default:r(()=>[g(p(s.$t("login.forgotPassword")),1)]),_:1})]),n("div",de,[a(o(O),{type:"primary",block:"",loading:S.value,onClick:V,class:"login-button"},{icon:r(()=>[a(o(v),{component:o(A)},null,8,["component"])]),default:r(()=>[g(" "+p(s.$t("login.login")),1)]),_:1},8,["loading"])]),a(o(G),{class:"login-divider"},{default:r(()=>[a(o(k),{depth:"3",style:{"font-size":"12px"}},{default:r(()=>e[2]||(e[2]=[g("或")])),_:1})]),_:1}),n("div",ge,[a(o(O),{block:"",loading:y.value,onClick:q,class:"sso-login-button",secondary:""},{icon:r(()=>[a(o(v),{component:o(X)},null,8,["component"])]),default:r(()=>[e[3]||(e[3]=g(" SSO 单点登录 "))]),_:1},8,["loading"])])])])])]),_:1},8,["show"])]))}});const ve=K(pe,[["__scopeId","data-v-3ee298e3"]]);export{ve as default};

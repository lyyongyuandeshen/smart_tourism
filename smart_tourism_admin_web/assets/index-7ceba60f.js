import{b6 as F,d as pe,a2 as fe,r as u,bS as L,a4 as T,$ as ge,o as U,c as N,a as i,b as r,ab as p,R as n,a6 as B,w as d,ah as P,al as ve,N as me,aS as D,a5 as M,ac as $,ad as W,b7 as ye}from"./index-5805bd08.js";import{d as j,u as he,g as _e}from"./tos-7145a97c.js";import{N as we}from"./DataTable-f0affd58.js";import{N as xe}from"./Pagination-78bedb34.js";import{N as be}from"./Form-9e4f5768.js";import{N as q}from"./FormItem-8b481c62.js";import{N as ke}from"./Upload-bdfd020e.js";import"./Forward-dbe0c59b.js";function ze(v){return F({url:"/v1/cultural-heritage/list",method:"get",params:v})}function A(v){return F({url:`/v1/cultural-heritage/${v}`,method:"get"})}function Se(v){return F({url:"/v1/cultural-heritage/upload",method:"post",data:v})}function K(v){return F({url:`/v1/cultural-heritage/${v}`,method:"delete"})}const Ce={class:"archive-container"},Ue={class:"h-full flex flex-col"},Ne={class:"filter-section"},Pe={class:"filter-content"},Fe={class:"filter-left"},Re={class:"filter-item"},Ee={class:"filter-item"},Le={class:"filter-item"},Te={class:"filter-right"},De={class:"content-section"},Me={class:"content-wrapper"},$e={class:"table-container"},Ie={class:"table-wrapper"},Oe={class:"pagination-wrapper"},He={class:"total-count"},Ve={style:{"margin-left":"8px"}},Be={key:0,class:"preview-content preview-image"},We=["src"],je={key:1,class:"preview-content preview-video"},qe=["src"],Ae={key:2,class:"preview-content preview-file"},Ke=pe({__name:"index",setup(v){const s=fe(),m=u(!1),f=L({keyword:"",tag:null,file_type:null}),I=u([{label:"全部标签",value:null},{label:"非遗",value:"非遗"},{label:"古建",value:"古建"},{label:"民俗",value:"民俗"},{label:"文献",value:"文献"}]),G=u([{label:"全部类型",value:null},{label:"文件",value:"文件"},{label:"图片",value:"图片"},{label:"视频",value:"视频"}]),J={非遗:"error",古建:"success",民俗:"warning",文献:"info"},Q={图片:{icon:"ri:image-line",color:"#ff9800"},文件:{icon:"ri:file-text-line",color:"#2196f3"},视频:{icon:"ri:video-line",color:"#f44336"}},O=u([]),H=u([]),k=u(!1),z=u(null),h=u(!1),S=u(""),a=L({file_name:"",file_type:"文件",tag:"非遗",url:"",files:[]}),R=u(!1),w=u(""),x=u("file"),X={tag:[{required:!0,message:"请选择所属标签",trigger:"change"}],files:[{required:!0,message:"请上传文件",trigger:"change",validator:(t,e)=>!e||e.length===0?new Error("请上传文件"):!0}]},Y=u((()=>[{type:"selection"},{title:"文件名称",key:"file_name",width:300,render:t=>{const e=Q[t.file_type]||{icon:"ri:file-line",color:"#666"};return d("div",{style:"display: flex; align-items: center; gap: 8px;"},[d("div",{style:`
                  width: 32px;
                  height: 32px;
                  background-color: ${e.color}20;
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  flex-shrink: 0;
                `},[d(P,{icon:e.icon,style:`color: ${e.color}; font-size: 18px;`})]),d("span",{style:"overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"},t.file_name)])}},{title:"文件类型",key:"file_type",width:120},{title:"所属标签",key:"tag",width:200,render:t=>{const e=t.tag?t.tag.split(",").map(l=>l.trim()):[];return d("div",{style:"display: flex; gap: 4px; flex-wrap: wrap;"},e.map(l=>d(ve,{type:J[l]||"default",size:"small"},{default:()=>l})))}},{title:"上传时间",key:"created_at",width:180,render:t=>t.created_at?new Date(t.created_at).toLocaleString("zh-CN"):"-"},{title:"操作",key:"actions",width:250,fixed:"right",render:t=>{const e=t.file_type==="图片"||t.file_type==="视频";return d("div",{class:"action-cell",style:"display: inline-flex; align-items: center; gap: 8px;"},[e?d("span",{class:"action-link preview",style:{fontSize:"14px",color:"#1890ff",cursor:"pointer"},onClick:()=>ie(t)},"预览"):null,e?d("span",{class:"action-divider",style:{color:"#d9d9d9"}},"|"):null,d("span",{class:"action-link edit",style:{fontSize:"14px",color:"#1890ff",cursor:"pointer"},onClick:()=>ae(t)},"编辑"),d("span",{class:"action-divider",style:{color:"#d9d9d9"}},"|"),d("span",{class:"action-link history",style:{fontSize:"14px",color:"#1890ff",cursor:"pointer"},onClick:()=>se(t)},"历史版本"),d("span",{class:"action-divider",style:{color:"#d9d9d9"}},"|"),d("span",{class:"action-link delete",style:{fontSize:"14px",color:"#ff4d4f",cursor:"pointer"},onClick:()=>re(t.file_id)},"删除")])}}])()),o=L({page:1,pageSize:10,itemCount:0,pageSizes:[10,20,30,50],showSizePicker:!0,onUpdatePage:t=>{o.page=t,y()},onUpdatePageSize:t=>{o.pageSize=t,o.page=1,y()}}),y=async()=>{try{m.value=!0;const t=await ze({file_name:f.keyword||void 0,tag:f.tag||void 0,file_type:f.file_type||void 0,page:o.page,page_size:o.pageSize});t.success?(O.value=t.data||[],o.itemCount=t.total||0):s.error(t.message||"获取数据失败")}catch(t){console.error("获取数据失败:",t),s.error(t.message||"获取数据失败")}finally{m.value=!1}};T(()=>f.keyword,()=>{o.page=1,y()}),T(()=>f.tag,()=>{o.page=1,y()}),T(()=>f.file_type,()=>{o.page=1,y()});const Z=()=>{h.value=!1,S.value="",a.tag="非遗",a.files=[],a.file_name="",a.file_type="文件",a.url="",k.value=!0,setTimeout(()=>{var t;(t=z.value)==null||t.restoreValidation()},0)},ee=t=>{var e;if(a.files=t.fileList,t.fileList.length>0){const l=t.fileList[0],g=l.file;if(g){a.file_name=l.name||g.name||"";const _=((e=(l.name||g.name||"").split(".").pop())==null?void 0:e.toLowerCase())||"";["jpg","jpeg","png","gif","bmp","webp","svg"].includes(_)?a.file_type="图片":["mp4","avi","mov","wmv","flv","mkv","webm"].includes(_)?a.file_type="视频":a.file_type="文件"}}},te=t=>{const e=t.file.file;return e?e.size/1024/1024<50?!0:(s.error("文件大小不能超过 50MB"),!1):!0},le=()=>new Promise((t,e)=>{var l;(l=z.value)==null||l.validate(async g=>{if(g){console.log("表单验证失败:",g),e(g);return}if(!a.files||a.files.length===0){s.error("请上传文件"),e(new Error("请上传文件"));return}try{if(m.value=!0,h.value&&a.url){try{const ue=a.url.split("/").slice(-2).join("/");await j(ue)}catch(V){console.warn("删除旧文件失败:",V)}await K(S.value)}const c=a.files[0],_=c.file;if(!_){s.error("文件对象不存在"),e(new Error("文件对象不存在"));return}const ne=a.file_name||c.name||_.name||"",C=a.file_type||"文件",b=await he(_,C==="图片"?"image":C==="视频"?"video":"image",`cultural-heritage/${a.tag}`,C==="图片");if(!b.success||!b.data){s.error(b.message||"文件上传失败"),e(new Error(b.message||"文件上传失败"));return}const ce=b.data.file_url,de={file_id:h.value?S.value:`FH${Date.now()}${Math.random().toString(36).substr(2,9)}`,file_name:ne,file_type:C,tag:a.tag,url:ce},E=await Se(de);E.success?(s.success(h.value?"编辑成功":"新增成功"),y(),t()):(s.error(E.message||"操作失败"),e(new Error(E.message||"操作失败")))}catch(c){console.error("操作失败:",c),s.error(c.message||"操作失败"),e(c)}finally{m.value=!1}})}),ae=async t=>{try{const e=await A(t.file_id);e?(h.value=!0,S.value=t.file_id,a.file_name=e.file_name||t.file_name,a.file_type=e.file_type||t.file_type,a.tag=e.tag||t.tag,a.url=e.url||t.url,a.files=[],k.value=!0,setTimeout(()=>{var l;(l=z.value)==null||l.restoreValidation()},0)):s.error(e.message||"获取详情失败")}catch(e){console.error("获取详情失败:",e),s.error(e.message||"获取详情失败")}},ie=async t=>{try{if(!t.url){s.warning("文件URL不存在");return}m.value=!0;let e="";try{if(t.url.startsWith("http://")||t.url.startsWith("https://")){let c=new URL(t.url).pathname;c.startsWith("/")&&(c=c.substring(1)),e=c}else e=t.url.startsWith("/")?t.url.substring(1):t.url}catch{e=t.url.startsWith("/")?t.url.substring(1):t.url}if(e.includes("?")&&(e=e.split("?")[0]),e.includes("#")&&(e=e.split("#")[0]),!e){s.warning("无法解析文件路径"),m.value=!1;return}const l=await _e([{file_path:e}]);l.success&&l.data&&l.data.length>0?(w.value=l.data[0].url,x.value=t.file_type==="图片"?"image":t.file_type==="视频"?"video":"file",R.value=!0):s.warning(l.message||"无法获取预览URL")}catch(e){console.error("预览失败:",e),s.error(e.message||"预览失败")}finally{m.value=!1}},se=t=>{s.info(`查看 ${t.file_name} 的历史版本`)},oe=()=>{w.value&&(window.open(w.value,"_blank")||s.warning("无法打开新窗口，请检查浏览器设置"))},re=async t=>{try{const e=await A(t);if(e&&e.url)try{const c=e.url.split("/").slice(-2).join("/");await j(c)}catch(g){console.warn("删除TOS文件失败:",g)}const l=await K(t);l.success?(s.success("删除成功"),y()):s.error(l.message||"删除失败")}catch(e){console.error("删除失败:",e),s.error(e.message||"删除失败")}};return ge(()=>{y()}),(t,e)=>(U(),N("div",Ce,[i("div",Ue,[e[11]||(e[11]=i("div",{class:"header-section"},[i("div",{class:"header-title"},"文化遗产数字化档案管理"),i("div",{class:"header-placeholder"})],-1)),i("div",Ne,[i("div",Pe,[i("div",Fe,[i("div",Re,[r(n(me),{value:f.keyword,"onUpdate:value":e[0]||(e[0]=l=>f.keyword=l),placeholder:"搜索关键词",clearable:"",style:{width:"220px"}},{suffix:p(()=>[r(n(P),{icon:"ri:search-line"})]),_:1},8,["value"])]),i("div",Ee,[r(n(D),{value:f.tag,"onUpdate:value":e[1]||(e[1]=l=>f.tag=l),options:I.value,placeholder:"所属标签",clearable:"",style:{width:"180px"}},null,8,["value","options"])]),i("div",Le,[r(n(D),{value:f.file_type,"onUpdate:value":e[2]||(e[2]=l=>f.file_type=l),options:G.value,placeholder:"文件类型",clearable:"",style:{width:"180px"}},null,8,["value","options"])])]),i("div",Te,[r(n($),{type:"primary",onClick:Z},{icon:p(()=>[r(n(P),{icon:"ri:add-line"})]),default:p(()=>[e[10]||(e[10]=M(" 新增档案 ",-1))]),_:1})])])]),i("div",De,[i("div",Me,[i("div",$e,[i("div",Ie,[r(n(we),{columns:Y.value,data:O.value,pagination:!1,"row-key":l=>l.file_id,"checked-row-keys":H.value,"onUpdate:checkedRowKeys":e[3]||(e[3]=l=>H.value=l),loading:m.value,striped:""},null,8,["columns","data","row-key","checked-row-keys","loading"])]),i("div",Oe,[i("span",He,"共"+B(o.itemCount)+"条",1),r(n(xe),{page:o.page,"onUpdate:page":[e[4]||(e[4]=l=>o.page=l),o.onUpdatePage],"page-size":o.pageSize,"onUpdate:pageSize":[e[5]||(e[5]=l=>o.pageSize=l),o.onUpdatePageSize],"item-count":o.itemCount,"page-sizes":o.pageSizes,"show-size-picker":"","page-slot":7},{suffix:p(()=>[i("span",Ve,B(o.pageSize)+"条/页",1)]),_:1},8,["page","page-size","item-count","page-sizes","onUpdate:page","onUpdate:pageSize"])])])])])]),r(n(W),{show:R.value,"onUpdate:show":e[6]||(e[6]=l=>R.value=l),"show-icon":!1,preset:"card",title:x.value==="image"?"图片预览":x.value==="video"?"视频预览":"文件预览",style:{width:"90vw","max-width":"1200px"},class:"preview-modal","mask-closable":!0},{default:p(()=>[x.value==="image"?(U(),N("div",Be,[i("img",{class:"al-center",src:w.value,alt:""},null,8,We)])):x.value==="video"?(U(),N("div",je,[i("video",{class:"al-center",src:w.value,controls:"",preload:"metadata"},null,8,qe)])):(U(),N("div",Ae,[e[13]||(e[13]=i("p",null,"该文件类型不支持预览",-1)),r(n($),{type:"primary",onClick:oe},{default:p(()=>[...e[12]||(e[12]=[M("下载文件",-1)])]),_:1})]))]),_:1},8,["show","title"]),r(n(W),{show:k.value,"onUpdate:show":e[9]||(e[9]=l=>k.value=l),"show-icon":!1,preset:"dialog",title:h.value?"编辑档案":"新增档案","positive-text":"提交","negative-text":"取消",onPositiveClick:le,style:{width:"600px"},class:"archive-modal"},{default:p(()=>[r(n(be),{ref_key:"addFormRef",ref:z,model:a,rules:X,"label-placement":"top"},{default:p(()=>[r(n(q),{label:"所属标签",path:"tag"},{default:p(()=>[r(n(D),{value:a.tag,"onUpdate:value":e[7]||(e[7]=l=>a.tag=l),options:I.value.filter(l=>l.value!==null),placeholder:"请选择所属标签"},null,8,["value","options"])]),_:1}),r(n(q),{label:"文件",path:"files"},{default:p(()=>[r(n(ke),{"file-list":a.files,"onUpdate:fileList":e[8]||(e[8]=l=>a.files=l),max:1,"before-upload":te,onChange:ee,"default-upload":!1,"list-type":"text"},{default:p(()=>[r(n($),{text:"",type:"info"},{icon:p(()=>[r(n(P),{icon:"ri:upload-cloud-line"})]),default:p(()=>[e[14]||(e[14]=M(" 点击上传文件 ",-1))]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])]))}});const st=ye(Ke,[["__scopeId","data-v-42f952c8"]]);export{st as default};

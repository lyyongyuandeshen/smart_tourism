import{d as Q,r as v,$ as Z,bj as ge,o as R,c as I,a as i,b6 as J,b9 as B,bS as E,a2 as me,b as o,ab as n,R as s,w,ah as U,bU as ye,a8 as W,N as L,aS as D,ac as S,a5 as A,a6 as P,bW as _e,Q as be,a1 as G,ad as H}from"./index-fc2ca07d.js";import{A as he}from"./index-1efe5955.js";import{N as we,a as ke}from"./Upload-7895b36e.js";import{N as K}from"./Space-29132ab6.js";import{N as Ce}from"./DatePicker-f677266b.js";import{N as xe}from"./DataTable-2e69da2a.js";import{N as Me}from"./Pagination-078592c4.js";import{N as ze}from"./Form-97fa87e1.js";import{N as F}from"./FormItem-9918da75.js";import"./Forward-86f34074.js";const Ne={class:"map-container-wrapper"},Ue=Q({__name:"MapContainer",props:{autoLocate:{type:Boolean},initialCenter:{},initialZoom:{}},emits:["map-ready","poi-click"],setup(y,{emit:T}){const M=y,d=T,z=v(null);let f=null,r=null;const k=async()=>{if(z.value)try{window._AMapSecurityConfig={securityJsCode:"a3ae5b960f3ed908393672ac36fc7bf1"};const u=await he.load({key:"d7dd3eae862ecc57ed11d6f603358601",version:"2.0",plugins:["AMap.ToolBar","AMap.Scale","AMap.Geolocation","AMap.Geocoder"],AMapUI:{version:"1.1",plugins:[]}});f=new u.Map(z.value,{zoom:M.initialZoom||11,center:M.initialCenter||[116.397428,39.90923],viewMode:"3D",pitch:30}),f.addControl(new u.ToolBar),f.addControl(new u.Scale),r=new u.Geocoder({city:"010",radius:1e3}),d("map-ready",f),C(),M.autoLocate&&h(u)}catch(u){console.error("地图初始化失败:",u)}},C=()=>{!f||!r||f.on("click",u=>{const p=u.lnglat;r.getAddress(p,(t,g)=>{if(t==="complete"&&g.regeocode){const _={lnglat:p,longitude:p.getLng(),latitude:p.getLat(),address:g.regeocode.formattedAddress,addressComponent:g.regeocode.addressComponent,pois:g.regeocode.pois||[],businessAreas:g.regeocode.businessAreas||[]};console.log("点击位置信息:",_),d("poi-click",_)}else console.error("根据经纬度查询地址失败:",g)})})},h=u=>{const p=new u.Geolocation({enableHighAccuracy:!0,timeout:1e4,buttonOffset:new u.Pixel(10,20),zoomToAccuracy:!0});f.addControl(p),p.getCurrentPosition(),p.on("complete",t=>{console.log("定位成功:",t)}),p.on("error",t=>{console.error("定位失败:",t)})};return Z(()=>{k()}),ge(()=>{f&&(f.destroy(),f=null),r=null}),(u,p)=>(R(),I("div",Ne,[i("div",{ref_key:"mapContainer",ref:z,class:"map-container"},null,512)]))}});const Se=J(Ue,[["__scopeId","data-v-8fc091db"]]);function Ae(y){return B({url:"/api/v1/facilities/list",method:"get",params:y})}function Pe(y){return B({url:`/api/v1/facilities/${y}`,method:"get"})}function Fe(y){return B({url:"/api/v1/facilities/upload",method:"post",data:y})}function Te(y){return B({url:`/api/v1/facilities/${y}`,method:"delete"})}const Le={class:"facility-container"},De={class:"header-section"},Re={class:"header-menu"},Be={class:"menu-buttons"},$e={class:"filter-section"},Ve={class:"filter-content"},Ee={class:"filter-item"},Ie={class:"filter-item"},qe={class:"filter-item"},Oe={class:"filter-item"},We={class:"filter-item"},Ge={class:"filter-actions"},He={class:"content-section"},Ke={class:"content-wrapper"},Qe={class:"table-container"},Ze={class:"table-header"},Je={class:"table-wrapper"},je={class:"pagination-wrapper"},Xe={class:"total-count"},Ye={style:{padding:"20px 0"}},et={style:{"font-size":"48px",color:"#999","margin-bottom":"8px"}},tt={style:{display:"flex",gap:"8px",width:"100%"}},at={key:0,style:{"margin-top":"8px","font-size":"12px",color:"#999"}},lt={class:"map-picker-content"},it={class:"map-wrapper"},ot={class:"map-info-bar"},st={class:"info-item"},nt={class:"info-value"},dt={class:"info-item"},rt={class:"info-value"},ut={class:"info-item full-width"},ct={class:"info-value"},pt={class:"map-modal-footer"},ft=Q({__name:"index",setup(y){const T=v("list"),M=a=>{T.value=a},d=E({deviceCode:null,deviceName:null,status:null,deviceType:null,updateTime:null}),z=v([{label:"全部状态",value:null},{label:"正常",value:"正常"},{label:"维修",value:"维修"},{label:"暂停",value:"暂停"},{label:"已拆除",value:"已拆除"}]),f=v([{label:"全部类型",value:null},{label:"洗手间",value:"洗手间"},{label:"儿童乐园",value:"儿童乐园"},{label:"休息区",value:"休息区"},{label:"轮椅通道",value:"轮椅通道"},{label:"互动体验",value:"互动体验"},{label:"便民点",value:"便民点"},{label:"避难点",value:"避难点"},{label:"风景名胜",value:"风景名胜"},{label:"紧急出口",value:"紧急出口"}]),r=me(),k=v(!1),C=v(!1),h=v(!1),u=v(""),p=v(null),t=E({facility_id:"",facility_name:"",category:"",icon:[],position_desc:"",longitude:null,latitude:null,status:"正常"}),g=v(!1);let _=null,m=null;const j={facility_name:[{required:!0,message:"请输入设备名称",trigger:"blur"}],category:[{required:!0,message:"请选择分类",trigger:"change"}],position_desc:[{required:!0,message:"请选择位置",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"change"}]},X=a=>{t.icon=a.fileList},Y=a=>a.type.startsWith("image/")?a.size/1024/1024<2?!0:(r.error("图片大小不能超过 2MB"),!1):(r.error("只能上传图片文件"),!1),ee=()=>{c.page=1,x()},te=()=>{d.deviceCode=null,d.deviceName=null,d.status=null,d.deviceType=null,d.updateTime=null,c.page=1,x()},q=v([]),O=v([]),ae={正常:{label:"正常",color:"#1890ff"},维修:{label:"维修",color:"#faad14"},暂停:{label:"暂停",color:"#ff4d4f"},已拆除:{label:"已拆除",color:"#999"}},le=v((()=>[{type:"selection"},{title:"设备编码",key:"facility_id",width:150},{title:"设备名称",key:"facility_name",width:180},{title:"分类",key:"category",width:120},{title:"图标",key:"icon",width:80,render:a=>a.icon&&a.icon.startsWith("ri:")?w(U,{icon:a.icon,style:"font-size: 20px; color: #1890ff;"}):w("span",{style:"color: #999; font-size: 12px;"},"无")},{title:"位置",key:"position_desc",width:200,ellipsis:{tooltip:!0}},{title:"状态",key:"status",width:100,render:a=>{const e=ae[a.status]||{label:a.status,color:"#999"};return w("div",{class:"status-cell",style:"display: inline-flex; align-items: center; gap: 6px;"},[w("span",{class:"status-dot",style:{width:"8px",height:"8px",minWidth:"8px",minHeight:"8px",borderRadius:"50%",display:"inline-block",flexShrink:"0",backgroundColor:e.color}}),w("span",{class:"status-text",style:"font-size: 14px; color: #333;"},e.label)])}},{title:"更新时间",key:"updated_at",width:180,render:a=>new Date(a.updated_at).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})},{title:"操作",key:"actions",width:150,render:a=>w("div",{class:"action-cell",style:"display: inline-flex; align-items: center; gap: 8px;"},[w("span",{class:"action-link edit",style:{fontSize:"14px",color:"#1890ff",cursor:"pointer"},onClick:()=>ne(a)},"编辑"),w("span",{class:"action-divider",style:{color:"#d9d9d9"}},"|"),w("span",{class:"action-link delete",style:{fontSize:"14px",color:"#ff4d4f",cursor:"pointer"},onClick:()=>de(a.facility_id)},"删除")])}])()),c=E({page:1,pageSize:10,itemCount:0,pageSizes:[10,20,30,50],showSizePicker:!0,onUpdatePage:a=>{c.page=a,x()},onUpdatePageSize:a=>{c.pageSize=a,c.page=1,x()}}),x=async()=>{try{k.value=!0;const a=await Ae({facility_id:d.deviceCode||void 0,facility_name:d.deviceName||void 0,category:d.deviceType||void 0,status:d.status||void 0,page:c.page,page_size:c.pageSize});a.success?(q.value=a.data||[],c.itemCount=a.total||0):r.error(a.message||"获取设备列表失败")}catch(a){console.error("获取设备列表失败:",a),r.error(a.message||"获取设备列表失败")}finally{k.value=!1}},ie=()=>{h.value=!1,u.value="",t.facility_id=`FAC${Date.now().toString().slice(-8)}`,t.facility_name="",t.category="",t.icon=[],t.position_desc="",t.longitude=null,t.latitude=null,t.status="正常",C.value=!0,setTimeout(()=>{var a;(a=p.value)==null||a.restoreValidation()},0)},oe=()=>new Promise((a,e)=>{var l;(l=p.value)==null||l.validate(async b=>{if(b){console.log("表单验证失败:",b),e(b);return}try{k.value=!0;let N="ri:building-line";if(t.icon&&t.icon.length>0){const V=t.icon[0];N=V.url||(V.file?URL.createObjectURL(V.file):"ri:building-line")}const ve={facility_id:h.value?u.value:t.facility_id,facility_name:t.facility_name,category:t.category,icon:N,position_desc:t.position_desc,longitude:t.longitude,latitude:t.latitude,status:t.status},$=await Fe(ve);$.success?(r.success(h.value?"编辑设备成功":"新增设备成功"),x(),a()):(r.error($.message||(h.value?"编辑设备失败":"新增设备失败")),e(new Error($.message)))}catch(N){console.error("操作失败:",N),r.error(N.message||"操作失败"),e(N)}finally{k.value=!1}})}),se=()=>{C.value=!1},ne=async a=>{try{const e=await Pe(a.facility_id);if(e){if(h.value=!0,u.value=a.facility_id,t.facility_id=e.facility_id||a.facility_id,t.facility_name=e.facility_name||a.facility_name,t.category=e.category||a.category,t.position_desc=e.position_desc||a.position_desc,t.longitude=e.longitude?parseFloat(e.longitude):null,t.latitude=e.latitude?parseFloat(e.latitude):null,t.status=e.status||a.status,e.icon||a.icon){const l=e.icon||a.icon;l&&!l.startsWith("ri:")?t.icon=[{id:Date.now().toString(),name:"icon.png",status:"finished",url:l}]:t.icon=[]}else t.icon=[];C.value=!0,setTimeout(()=>{var l;(l=p.value)==null||l.restoreValidation()},0)}else r.error("获取设备详情失败")}catch(e){console.error("获取设备详情失败:",e),r.error(e.message||"获取设备详情失败")}},de=async a=>{try{const e=await Te(a);e.success?(r.success("删除成功"),x()):r.error(e.message||"删除失败")}catch(e){console.error("删除失败:",e),r.error(e.message||"删除失败")}},re=()=>{g.value=!0},ue=a=>{if(_=a,t.longitude&&t.latitude){const e=window.AMap;e&&(m=new e.Marker({position:[t.longitude,t.latitude],draggable:!0}),m.setMap(a),a.setCenter([t.longitude,t.latitude]),m.on("dragend",l=>{const b=l.lnglat||l.target.getPosition();a.emit("click",{lnglat:b})}))}},ce=a=>{t.longitude=a.longitude,t.latitude=a.latitude,t.position_desc=a.address;const e=window.AMap;e&&_&&(m?m.setPosition([a.longitude,a.latitude]):(m=new e.Marker({position:[a.longitude,a.latitude],draggable:!0}),m.setMap(_),m.on("dragend",l=>{const b=l.lnglat||l.target.getPosition();_.emit("click",{lnglat:b})})),_.setCenter([a.longitude,a.latitude]))},pe=()=>{if(!t.longitude||!t.latitude){r.warning("请在地图上选择位置");return}g.value=!1,r.success("位置选择成功")},fe=()=>{g.value=!1,m&&_&&(_.remove(m),m=null)};return Z(()=>{x()}),(a,e)=>(R(),I("div",Le,[o(s(_e),{"has-sider":"",class:"h-full w-full"},{default:n(()=>[o(s(ye),{class:"h-full flex flex-col"},{default:n(()=>[i("div",De,[e[18]||(e[18]=i("div",{class:"header-title"},"设施设备管理",-1)),i("div",Re,[i("div",Be,[i("span",{onClick:e[0]||(e[0]=l=>M("list")),class:W(["menu-button",{"menu-button-active":T.value==="list"}])}," 设施设备列表 ",2),i("span",{onClick:e[1]||(e[1]=l=>M("location")),class:W(["menu-button",{"menu-button-active":T.value==="location"}])}," 位置打点 ",2)])]),e[19]||(e[19]=i("div",{class:"header-placeholder"},null,-1))]),i("div",$e,[i("div",Ve,[o(s(K),{size:16,align:"center",wrap:""},{default:n(()=>[i("div",Ee,[e[20]||(e[20]=i("span",{class:"filter-label"},"设备编码：",-1)),o(s(L),{value:d.deviceCode,"onUpdate:value":e[2]||(e[2]=l=>d.deviceCode=l),placeholder:"请输入设备编码",clearable:"",style:{width:"180px"}},null,8,["value"])]),i("div",Ie,[e[21]||(e[21]=i("span",{class:"filter-label"},"设备名称：",-1)),o(s(L),{value:d.deviceName,"onUpdate:value":e[3]||(e[3]=l=>d.deviceName=l),placeholder:"请输入设备名称",clearable:"",style:{width:"180px"}},null,8,["value"])]),i("div",qe,[e[22]||(e[22]=i("span",{class:"filter-label"},"状态：",-1)),o(s(D),{value:d.status,"onUpdate:value":e[4]||(e[4]=l=>d.status=l),options:z.value,placeholder:"请选择状态",clearable:"",style:{width:"180px"}},null,8,["value","options"])]),i("div",Oe,[e[23]||(e[23]=i("span",{class:"filter-label"},"设备类型：",-1)),o(s(D),{value:d.deviceType,"onUpdate:value":e[5]||(e[5]=l=>d.deviceType=l),options:f.value,placeholder:"请选择设备类型",clearable:"",style:{width:"180px"}},null,8,["value","options"])]),i("div",We,[e[24]||(e[24]=i("span",{class:"filter-label"},"更新时间：",-1)),o(s(Ce),{value:d.updateTime,"onUpdate:value":e[6]||(e[6]=l=>d.updateTime=l),type:"datetimerange",placeholder:"请选择更新时间",clearable:"",style:{width:"400px"}},null,8,["value"])])]),_:1})]),e[27]||(e[27]=i("div",{class:"filter-divider"},null,-1)),i("div",Ge,[o(s(K),{size:12,vertical:""},{default:n(()=>[o(s(S),{type:"primary",class:"filter-btn",onClick:ee},{icon:n(()=>[o(s(U),{icon:"ri:search-line"})]),default:n(()=>[e[25]||(e[25]=A(" 查询 "))]),_:1}),o(s(S),{class:"reset-btn",onClick:te},{icon:n(()=>[o(s(U),{icon:"ri:refresh-line"})]),default:n(()=>[e[26]||(e[26]=A(" 重置 "))]),_:1})]),_:1})])]),i("div",He,[i("div",Ke,[i("div",Qe,[i("div",Ze,[o(s(S),{type:"primary",class:"add-btn",onClick:ie},{icon:n(()=>[o(s(U),{icon:"ri:add-line"})]),default:n(()=>[e[28]||(e[28]=A(" 新增设备 "))]),_:1})]),i("div",Je,[o(s(xe),{columns:le.value,data:q.value,loading:k.value,pagination:!1,"row-key":l=>l.facility_id,"checked-row-keys":O.value,"onUpdate:checkedRowKeys":e[7]||(e[7]=l=>O.value=l),striped:""},null,8,["columns","data","loading","row-key","checked-row-keys"])]),i("div",je,[i("span",Xe,"共 "+P(c.itemCount)+" 条",1),o(s(Me),{page:c.page,"onUpdate:page":[e[8]||(e[8]=l=>c.page=l),c.onUpdatePage],"page-size":c.pageSize,"onUpdate:pageSize":[e[9]||(e[9]=l=>c.pageSize=l),c.onUpdatePageSize],"item-count":c.itemCount,"page-sizes":c.pageSizes,"show-size-picker":""},null,8,["page","page-size","item-count","page-sizes","onUpdate:page","onUpdate:pageSize"])])])])])]),_:1})]),_:1}),o(s(H),{show:C.value,"onUpdate:show":e[16]||(e[16]=l=>C.value=l),"show-icon":!1,preset:"dialog",title:h.value?"编辑设备":"新增设备","positive-text":"确定","negative-text":"取消",onPositiveClick:oe,onNegativeClick:se,style:{width:"600px"},class:"add-device-modal"},{default:n(()=>[o(s(ze),{ref_key:"addFormRef",ref:p,model:t,rules:j,"label-placement":"left","label-width":"100px"},{default:n(()=>[h.value?G("",!0):(R(),be(s(F),{key:0,label:"设备编码",path:"facility_id"},{default:n(()=>[o(s(L),{value:t.facility_id,"onUpdate:value":e[10]||(e[10]=l=>t.facility_id=l),placeholder:"自动生成",disabled:""},null,8,["value"])]),_:1})),o(s(F),{label:"设备名称",path:"facility_name"},{default:n(()=>[o(s(L),{value:t.facility_name,"onUpdate:value":e[11]||(e[11]=l=>t.facility_name=l),placeholder:"请输入设备名称",clearable:""},null,8,["value"])]),_:1}),o(s(F),{label:"分类",path:"category"},{default:n(()=>[o(s(D),{value:t.category,"onUpdate:value":e[12]||(e[12]=l=>t.category=l),options:f.value.filter(l=>l.value!==null),placeholder:"请选择分类",clearable:""},null,8,["value","options"])]),_:1}),o(s(F),{label:"图标",path:"icon"},{default:n(()=>[o(s(we),{"file-list":t.icon,"onUpdate:fileList":e[13]||(e[13]=l=>t.icon=l),max:1,"before-upload":Y,"list-type":"image-card",accept:"image/*",onChange:X},{default:n(()=>[o(s(ke),null,{default:n(()=>[i("div",Ye,[i("div",et,[o(s(U),{icon:"ri:upload-cloud-line"})]),e[29]||(e[29]=i("div",{style:{"font-size":"12px",color:"#999","margin-top":"4px"}},"上传图标（可选）",-1))])]),_:1})]),_:1},8,["file-list"])]),_:1}),o(s(F),{label:"位置",path:"position_desc"},{default:n(()=>[i("div",tt,[o(s(L),{value:t.position_desc,"onUpdate:value":e[14]||(e[14]=l=>t.position_desc=l),placeholder:"点击右侧按钮在地图上选择位置",readonly:"",style:{flex:"1"}},null,8,["value"]),o(s(S),{type:"primary",onClick:re},{icon:n(()=>[o(s(U),{icon:"ri:map-pin-line"})]),default:n(()=>[e[30]||(e[30]=A(" 选择 "))]),_:1})]),t.longitude&&t.latitude?(R(),I("div",at," 经度: "+P(t.longitude.toFixed(6))+", 纬度: "+P(t.latitude.toFixed(6)),1)):G("",!0)]),_:1}),o(s(F),{label:"状态",path:"status"},{default:n(()=>[o(s(D),{value:t.status,"onUpdate:value":e[15]||(e[15]=l=>t.status=l),options:z.value.filter(l=>l.value!==null),placeholder:"请选择状态",clearable:""},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),o(s(H),{show:g.value,"onUpdate:show":e[17]||(e[17]=l=>g.value=l),"show-icon":!1,preset:"card",title:"选择位置",style:{width:"900px",height:"700px"},class:"map-picker-modal"},{footer:n(()=>[i("div",pt,[o(s(S),{onClick:fe},{default:n(()=>e[35]||(e[35]=[A("取消")])),_:1}),o(s(S),{type:"primary",onClick:pe},{default:n(()=>e[36]||(e[36]=[A("确定")])),_:1})])]),default:n(()=>{var l,b;return[i("div",lt,[i("div",it,[o(Se,{"initial-center":t.longitude&&t.latitude?[t.longitude,t.latitude]:void 0,"initial-zoom":15,onMapReady:ue,onPoiClick:ce},null,8,["initial-center"])]),i("div",ot,[i("div",st,[e[31]||(e[31]=i("span",{class:"info-label"},"经度：",-1)),i("span",nt,P(((l=t.longitude)==null?void 0:l.toFixed(6))||"-"),1)]),i("div",dt,[e[32]||(e[32]=i("span",{class:"info-label"},"纬度：",-1)),i("span",rt,P(((b=t.latitude)==null?void 0:b.toFixed(6))||"-"),1)]),i("div",ut,[e[33]||(e[33]=i("span",{class:"info-label"},"地址：",-1)),i("span",ct,P(t.position_desc||"请在地图上点击选择位置"),1)])]),e[34]||(e[34]=i("div",{class:"map-tip"}," 提示：点击地图或拖动标记选择位置 ",-1))])]}),_:1},8,["show"])]))}});const Mt=J(ft,[["__scopeId","data-v-2d0c6ba8"]]);export{Mt as default};

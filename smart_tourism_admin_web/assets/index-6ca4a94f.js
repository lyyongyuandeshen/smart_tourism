import{b9 as oe,bb as ie,d as ee,n as J,o,c as r,a6 as b,a1 as F,A as G,bo as Q,a as e,X as L,aa as q,b as m,R as d,ah as H,r as $,u as re,bS as ue,a2 as de,$ as ce,a0 as pe,ab as U,ai as fe,bT as ve,c0 as ge,a8 as me,ac as V,c1 as be,Q as we,bc as xe,b8 as Z,c2 as _e,a5 as M,b7 as he,T as ye,N as ke,bW as Ce,ad as Ne,as as Te,b6 as Se}from"./index-fc2ca07d.js";function $e(x){return oe({url:"/workflow/public/search",method:"get",params:x})}async function Ue(x){return De("/api/workflow/run",{options:x.options,signal:x.signal,startCallback:x.startCallback||(()=>{}),messageReceived:x.messageReceived||(()=>{}),thinkingDataReceived:x.thinkingDataReceived||(()=>{}),doneCallback:x.doneCallback||(()=>{}),errorCallback:x.errorCallback||(()=>{})})}async function De(x,l){var D;try{const c=ie(),C=c.token?`Bearer ${c.token}`:"";console.log("SSE 请求配置:",{url:x,token:C?"已设置":"未设置",options:l.options});const _=await fetch(x,{method:"POST",headers:{"Content-Type":"application/json",Authorization:C,"Accept-Language":"zh_CN","Content-Language":"zh_CN",clientId:"web"},body:JSON.stringify({...l.options}),signal:l.signal});console.log("SSE 响应状态:",{status:_.status,statusText:_.statusText,contentType:_.headers.get("content-type"),ok:_.ok});const K=_.headers.get("content-type")||"";if(!_.ok||!K.includes("text/event-stream"))throw new Error(`SSE open failed: ${_.status} ${_.statusText}`);const s=(D=_.body)==null?void 0:D.getReader();if(!s)throw new Error("ReadableStream not supported");const p=new TextDecoder("utf-8");let a="";for(;;){const{done:w,value:f}=await s.read();if(w)break;a+=p.decode(f,{stream:!0});const N=a.split(`

`);a=N.pop()||"";for(const E of N){const O=E.split(`
`);let k="";const z=[];for(const P of O)P.startsWith("event:")?k=P.slice(6).trim():P.startsWith("data:")&&z.push(P.slice(5));let R=z.join(`
`);if(R.indexOf("-_wrap_-")===0&&(R=R.replace("-_wrap_-",`
`)),k==="[START]"){l.startCallback(R);continue}if(k==="[ERROR]"){l.errorCallback(R);continue}if(k==="[DONE]"){l.doneCallback(R);continue}if(k==="[AUDIO]"){l.audioDataReceived&&l.audioDataReceived(R);continue}if(k==="[THINKING]"){l.thinkingDataReceived&&l.thinkingDataReceived(R);continue}if(k==="[STATE_CHANGED]"){l.stateChanged&&l.stateChanged(R);continue}l.messageReceived(R,k)}}}catch(c){throw l.errorCallback((c==null?void 0:c.message)||String(c)),c}}const Re="/assets/workflow-dbdbd0bd.svg",Ee={key:0,class:"py-2 text-red-500"},Ie={key:1,class:"text-center py-2 text-neutral-400"},Oe=["title","name"],je={class:"flex items-center space-x-2 bg-gray-100 px-2 py-1 rounded-md"},Ae={class:"text-base"},Me={class:"flex flex-col space-y-2"},Pe={class:"min-w-24 pr-2"},ze={key:0,class:"flex"},Be={class:"whitespace-pre-wrap break-words"},Le={key:0,class:"flex flex-wrap gap-2"},Ke=["src","alt","onClick"],We={class:"min-w-24 pr-2"},qe={class:"whitespace-pre-wrap break-words"},He=ee({__name:"RuntimeNodes",props:{nodes:{},workflow:{},errorMsg:{},token:{}},setup(x){const l=x,D=J(()=>{var p;const s=(((p=l.workflow)==null?void 0:p.nodes)||[]).find(a=>{var w;return((w=a.wfComponent)==null?void 0:w.name)==="Start"});return((s==null?void 0:s.nodeConfig)||{}).prologue||""});function c(s){return!s.includes("http")&&!s.includes("/api")?`/api${s}`:s}function C(s){var p,a;return(s==null?void 0:s.workflowComponentId)??(s==null?void 0:s.wfComponentId)??((p=s==null?void 0:s.wfComponent)==null?void 0:p.id)??((a=s==null?void 0:s.wfComponent)==null?void 0:a.componentId)}function _(s){switch(String(s||"")){case"1":return"carbon:play-outline";case"2":return"carbon:closed-caption";case"3":return"carbon:question-answering";case"4":return"solar:pallete-2-linear";case"5":return"carbon:ibm-knowledge-catalog-standard";case"6":return"carbon:api-key";case"7":return"carbon:connect-target";case"8":return"oui:logstash-if";case"9":return"carbon:type-pattern";case"10":return"carbon:prompt-template";case"11":return"ri:google-line";case"14":return"covid:transmission-virus-human-transmit-2";case"15":return"carbon:mail-all";case"16":return"carbon:http";default:return"ri:information-line"}}function K(s){const p=window.open("","_blank","width=800,height=600,scrollbars=yes,resizable=yes");p&&(p.document.write(`
      <html>
        <head>
          <title>图片预览</title>
          <style>
            body { 
              margin: 0; 
              padding: 20px; 
              background: #f5f5f5; 
              display: flex; 
              justify-content: center; 
              align-items: center; 
              min-height: 100vh;
            }
            img { 
              max-width: 100%; 
              max-height: 100%; 
              border-radius: 8px; 
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
          </style>
        </head>
        <body>
          <img src="${s}" alt="预览图片" />
        </body>
      </html>
    `),p.document.close())}return(s,p)=>(o(),r("div",null,[s.errorMsg?(o(),r("div",Ee,"错误："+b(s.errorMsg),1)):s.nodes.length===0?(o(),r("div",Ie,"无内容")):F("",!0),G(e("div",{class:"p-2"},b(D.value),513),[[Q,D.value]]),(o(!0),r(L,null,q(s.nodes,a=>(o(),r("div",{key:a.uuid,class:"flex flex-col space-y-2 border border-gray-200 p-2 m-2 rounded-md",title:a.nodeTitle,name:a.uuid},[e("div",je,[m(d(H),{icon:_(C(a)),class:"text-base"},null,8,["icon"]),e("div",Ae,b(a.nodeTitle||"找不到节点标题"),1)]),e("div",Me,[p[0]||(p[0]=e("div",{class:"text-base border-b border-gray-200 py-1"},"输入",-1)),(o(!0),r(L,null,q(a.input,(w,f)=>(o(),r("div",{key:`input_${f}`,class:"flex"},[e("div",Pe,b(f),1),e("div",null,b(w.value||"无内容"),1)]))),128)),p[1]||(p[1]=e("div",{class:"text-base border-b border-gray-200 py-1"},"输出",-1)),a.chunks?(o(),r("div",ze,[e("div",Be,b(a.chunks),1)])):(o(!0),r(L,{key:1},q(a.output,(w,f)=>(o(),r("div",{key:`onput_${f}`,class:"flex"},[w.type===4?(o(),r("div",Le,[(o(!0),r(L,null,q(Array.isArray(w.value)?w.value:[w.value],N=>(o(),r("div",{key:String(N),class:"relative"},[e("img",{src:`${c(String(N))}?token=${s.token||""}`,alt:String(f),class:"w-24 h-24 object-cover rounded border border-gray-200 cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>K(`${c(String(N))}?token=${s.token||""}`)},null,8,Ke)]))),128))])):(o(),r(L,{key:1},[e("div",We,b(f),1),e("div",qe,b(w.value||"无内容"),1)],64))]))),128))])],8,Oe))),128))]))}}),Ve={class:"h-full flex"},Je={class:"h-full flex flex-col workflow-sider"},Fe={class:"px-2 pb-2"},Ge={key:0,class:"space-y-2"},Qe=["onClick"],Xe={class:"flex items-start gap-2"},Ye=["src"],Ze={class:"flex-1 min-w-0"},et={class:"flex items-center justify-between gap-2"},tt={class:"font-medium text-[13px] truncate"},st={class:"flex-1 h-full flex flex-col bg-white dark:bg-white"},at={class:"flex items-center justify-between px-4 h-[56px] border-b border-neutral-200 bg-white dark:bg-white"},nt={class:"font-medium text-neutral-800 truncate max-w-[70%]"},lt={class:"flex-1 bg-white dark:bg-white overflow-auto"},ot={class:"w-full max-w-[1100px] mx-auto px-6 py-10 h-full text-neutral-800"},it={key:0},rt={class:"w-full max-w-screen-xl m-auto z-10"},ut={class:"max-h-[65vh] overflow-y-auto mb-2"},dt={class:"sticky bottom-0 left-0 flex justify-center"},ct={key:0,class:"text-center text-neutral-400 py-8"},pt={key:1,class:"text-center text-neutral-600 py-8"},ft={key:1,class:"text-neutral-400 select-none flex items-center justify-center h-full"},vt={class:"px-6 bg-white dark:bg-white"},gt={class:"w-full max-w-[1100px] mx-auto pt-6 pb-10"},mt={class:"flex items-end gap-3"},bt={class:"space-y-3"},wt={class:"grid grid-cols-2 gap-2"},xt={class:"text-[13px]"},_t={class:"text-[13px]"},ht={class:"text-[13px]"},yt={class:"text-[13px]"},kt={class:"grid grid-cols-2 gap-2"},Ct={class:"text-[13px]"},Nt={class:"text-[13px]"},Tt=ee({__name:"index",setup(x){const l=$([]),D=$(null),c=$(""),C=$(!1),_=$(!1),{isMobile:K}=re(),s=$(!1),p=J(()=>{var n,t;return(n=B.value)!=null&&n.title||(t=B.value)!=null&&t.name?String(B.value.title||B.value.name):"工作流"}),a=$(!1),w=$(""),f=ue([]),N=$(""),E=$(!1),O=$({name:"runtimes",defaultTab:"流程执行详情",tab:"流程执行详情 ↓"}),k=de();let z=new AbortController;function R(n){n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),!C.value&&c.value.trim()&&Y())}const P=$(!1),j=$(null);function te(n){j.value=n,P.value=!0}const B=J(()=>l.value.find(n=>String(n.id)===String(D.value)));function se(n){D.value=n.id,f.splice(0,f.length),N.value="",E.value=!1,w.value="",a.value=!1}let X=!1;async function ae(){var n;if(!(_.value||X)){_.value=!0;try{const t=await $e({currentPage:1,pageSize:20});(n=t==null?void 0:t.data)!=null&&n.records?(l.value=t.data.records.map(u=>({id:u.id,name:u.name,title:u.title,desc:u.remark,remark:u.remark,uuid:u.uuid,isPublic:u.isPublic,userId:u.userId,userUuid:u.userUuid,userName:u.userName,nodes:u.nodes,edges:u.edges,createTime:u.createTime,updateTime:u.updateTime,isDeleted:u.isDeleted})),l.value.length>0&&(D.value=l.value[0].id)):(l.value=[{id:1,name:"示例工作流1",title:"示例工作流1",desc:"这是一个示例工作流",uuid:"example-uuid-1",nodes:[{inputConfig:{userInputs:[{uuid:"input-uuid-1",name:"var_user_input",title:"用户输入",type:1,required:!1}]}}]},{id:2,name:"示例工作流2",title:"示例工作流2",desc:"这是另一个示例工作流",uuid:"example-uuid-2",nodes:[{inputConfig:{userInputs:[{uuid:"input-uuid-2",name:"var_user_input",title:"用户输入",type:1,required:!1}]}}]}],D.value=l.value[0].id),X=!0}catch(t){console.error("加载工作流列表失败:",t)}finally{_.value=!1}}}async function Y(){var g;if(!D.value||!c.value.trim())return;const n=B.value;if(!n||!n.uuid||a.value)return;const t=n.nodes&&n.nodes.length>0?n.nodes[0]:null,u=((g=t==null?void 0:t.inputConfig)==null?void 0:g.user_inputs)||[];console.log("node0",t),console.log("uis",u);const W=u.map(v=>({uuid:v.uuid,name:v.name,content:{title:v.title,value:c.value,type:v.type},required:v.required}));a.value=!0,C.value=!0,E.value=!0,O.value.tab=E.value?`${O.value.defaultTab} ↓`:`${O.value.defaultTab} ↑`,z=new AbortController;try{w.value="";const v=new Map;f.splice(0,f.length),N.value="",await Ue({options:{uuid:n.uuid,inputs:W},signal:z.signal,startCallback:i=>{if(!i){k.error("启动失败");return}const A=JSON.parse(i);A.input={},W.forEach(h=>{A.input[h.name]={...h.content}}),w.value=A.uuid,console.log("工作流启动成功:",A)},thinkingDataReceived:i=>{console.log("Thinking data received:",i)},messageReceived:(i,A)=>{const h=A||"";try{if(h.includes("[NODE_RUN_")){const T=h.replace("[NODE_RUN_","").replace("]",""),I=JSON.parse(i);v.set(T,I.uuid);const y=((n==null?void 0:n.nodes)||[]).find(S=>S.uuid===T);y&&(I.nodeTitle=y.title,I.wfComponent=y.wfComponent),f.push(I)}else if(h.includes("[NODE_CHUNK_")){console.log("NODE_CHUNK_",h,i);const T=h.replace("[NODE_CHUNK_","").replace("]",""),I=v.get(T)||"",y=f.find(S=>S.uuid===I);y&&(y.chunks=(y.chunks||"")+i)}else if(h.includes("[NODE_INPUT_")){const T=h.replace("[NODE_INPUT_","").replace("]",""),I=v.get(T)||"",y=f.find(S=>S.uuid===I);if(y){const S=JSON.parse(i);y.input={...y.input,[S.name]:S.content}}}else if(h.includes("[NODE_OUTPUT_")){const T=h.replace("[NODE_OUTPUT_","").replace("]",""),I=v.get(T)||"",y=f.find(S=>S.uuid===I);if(y){const S=JSON.parse(i);y.output={...y.output,[S.name]:S.content}}}}catch(T){console.error("处理消息时出错:",T)}},doneCallback:i=>{Te(()=>{a.value=!1,C.value=!1,N.value="",k.success("执行成功"),console.log("工作流执行完成:",i)})},errorCallback:i=>{a.value=!1,C.value=!1,k.error(`系统提示：${i}`),N.value=i||"",console.error("工作流执行错误:",i)}})}catch(v){const i=(v==null?void 0:v.message)??"执行出错";k.error(i),a.value=!1,C.value=!1,N.value=i}c.value=""}function ne(){a.value&&(z.abort(),a.value=!1,C.value=!1,k.info("已停止执行"))}function le(){E.value=!E.value,O.value.tab=E.value?`${O.value.defaultTab} ↓`:`${O.value.defaultTab} ↑`}return ce(ae),pe(()=>{a.value&&z.abort()}),(n,t)=>{var u,W;return o(),r(L,null,[e("div",Ve,[m(d(Ce),{"has-sider":"",class:"h-full w-full"},{default:U(()=>[m(d(ve),{bordered:"",collapsed:s.value,"collapsed-width":0,width:220,"show-trigger":d(K)?!1:"arrow-circle","collapse-mode":"transform",onUpdateCollapsed:t[0]||(t[0]=g=>s.value=g)},{default:U(()=>[e("div",Je,[m(d(ge),{class:"flex-1",trigger:"none"},{default:U(()=>[e("div",Fe,[t[3]||(t[3]=e("div",{class:"flex justify-center mb-3 mt-2"},[e("div",{class:"wf-title-chip"},"工作流")],-1)),l.value.length?(o(),r("div",Ge,[(o(!0),r(L,null,q(l.value,g=>(o(),r("div",{key:g.id,class:me(["wf-card",[D.value===g.id?"ring-1 ring-[#1677ff33] bg-[#f7fbff]":""]]),onClick:v=>se(g)},[e("div",Xe,[e("img",{src:d(Re),alt:"workflow",width:"18",height:"18",class:"mt-[2px]"},null,8,Ye),e("div",Ze,[e("div",et,[e("div",tt,b(g.title||g.name),1),m(d(V),{text:"",size:"small",onClick:be(v=>te(g),["stop"])},{default:U(()=>[m(d(H),{icon:"ri:information-line"})]),_:2},1032,["onClick"])])])])],10,Qe))),128))])):(o(),we(d(xe),{key:1,description:"暂无工作流"}))])]),_:1})])]),_:1},8,["collapsed","show-trigger"]),e("div",st,[t[7]||(t[7]=e("div",{class:"workflow-divider"},null,-1)),e("div",at,[e("div",nt,b(p.value),1)]),e("div",lt,[e("div",ot,[B.value?(o(),r("div",it,[e("div",rt,[m(d(Z),{type:"line","justify-content":"space-evenly",animated:"","default-value":"runtimes"},{default:U(()=>[m(d(_e),{name:"runtimes",onClick:le},{default:U(()=>[M(b(O.value.tab),1)]),_:1})]),_:1}),m(d(Z),{type:"line","justify-content":"space-evenly",animated:""},{default:U(()=>[m(d(he),{name:"runtimes","display-directive":"show","tab-props":{style:"display:none"}},{default:U(()=>[m(ye,{name:"collapse"},{default:U(()=>[G(e("div",ut,[m(He,{nodes:f,workflow:B.value,"error-msg":N.value,token:""},null,8,["nodes","workflow","error-msg"]),e("div",dt,[G(m(d(V),{size:"tiny",onClick:ne},{icon:U(()=>[m(d(H),{icon:"ri:stop-circle-line"})]),default:U(()=>[t[4]||(t[4]=M(" 停止请求 "))]),_:1},512),[[Q,a.value]])])],512),[[Q,E.value]])]),_:1})]),_:1})]),_:1}),!E.value&&!a.value?(o(),r("div",ct," 请点击下方提交按钮开始执行工作流 ")):F("",!0),a.value&&f.length===0?(o(),r("div",pt,t[5]||(t[5]=[e("div",{class:"flex items-center justify-center gap-2"},[e("div",{class:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),M(" 工作流执行中... ")],-1)]))):F("",!0)])])):(o(),r("div",ft,"请选择一个工作流"))])]),e("div",vt,[e("div",gt,[t[6]||(t[6]=e("div",{class:"h-[1px] bg-neutral-200 mb-6"},null,-1)),e("div",mt,[m(d(ke),{value:c.value,"onUpdate:value":t[1]||(t[1]=g=>c.value=g),type:"textarea",autosize:{minRows:1,maxRows:6},placeholder:"请输入内容，Enter 提交，Shift + Enter 换行",clearable:"",onKeydown:R},null,8,["value"]),m(d(V),{type:"primary",loading:C.value,disabled:!c.value.trim()||C.value,circle:"",onClick:Y},{icon:U(()=>[m(d(H),{icon:"ri:send-plane-fill"})]),_:1},8,["loading","disabled"])])])])])]),_:1})]),m(d(Ne),{show:P.value,"onUpdate:show":t[2]||(t[2]=g=>P.value=g),preset:"card",title:((u=j.value)==null?void 0:u.title)||((W=j.value)==null?void 0:W.name)||"工作流详情",style:fe({width:d(K)?"90vw":"700px"}),"mask-closable":!0},{default:U(()=>{var g,v,i,A,h,T;return[e("div",bt,[e("div",wt,[e("div",null,[t[8]||(t[8]=e("span",{class:"text-[14px] text-neutral-600"},"标题:",-1)),t[9]||(t[9]=M()),e("span",xt,b((g=j.value)==null?void 0:g.title),1)]),e("div",null,[t[10]||(t[10]=e("span",{class:"text-[14px] text-neutral-600"},"UUID:",-1)),t[11]||(t[11]=M()),e("span",_t,b((v=j.value)==null?void 0:v.uuid),1)]),e("div",null,[t[12]||(t[12]=e("span",{class:"text-[14px] text-neutral-600"},"备注:",-1)),t[13]||(t[13]=M()),e("span",ht,b(((i=j.value)==null?void 0:i.remark)||"无"),1)]),e("div",null,[t[14]||(t[14]=e("span",{class:"text-[14px] text-neutral-600"},"公开:",-1)),t[15]||(t[15]=M()),e("span",yt,b((A=j.value)!=null&&A.isPublic?"是":"否"),1)])]),e("div",kt,[e("div",null,[t[16]||(t[16]=e("span",{class:"text-[14px] text-neutral-600"},"创建时间:",-1)),t[17]||(t[17]=M()),e("span",Ct,b((h=j.value)==null?void 0:h.createTime),1)]),e("div",null,[t[18]||(t[18]=e("span",{class:"text-[14px] text-neutral-600"},"更新时间:",-1)),t[19]||(t[19]=M()),e("span",Nt,b((T=j.value)==null?void 0:T.updateTime),1)])])])]}),_:1},8,["show","title","style"])],64)}}});const $t=Se(Tt,[["__scopeId","data-v-21c8299c"]]);export{$t as default};

import{d as q,r as g,$ as G,bj as _e,o as E,c as j,a as i,b7 as ee,b6 as I,bS as V,a2 as he,b as s,ab as r,R as o,w as y,ah as A,bU as be,a8 as Q,N as W,aS as B,ac as P,a5 as F,a6 as R,bW as we,Q as xe,a1 as Z,ad as J}from"./index-5805bd08.js";import{A as ke}from"./index-70bed514.js";import{u as Ce,g as X}from"./tos-7145a97c.js";import{N as Ue,a as Me}from"./Upload-bdfd020e.js";import{N as Y}from"./Space-a5c105a8.js";import{N as ze}from"./DatePicker-8deac17c.js";import{N as Ne}from"./DataTable-f0affd58.js";import{N as Se}from"./Pagination-78bedb34.js";import{N as Ae}from"./Form-9e4f5768.js";import{N as T}from"./FormItem-8b481c62.js";import"./Forward-dbe0c59b.js";const Pe={class:"map-container-wrapper"},Fe=q({__name:"MapContainer",props:{autoLocate:{type:Boolean},initialCenter:{},initialZoom:{}},emits:["map-ready","poi-click"],setup(h,{emit:$}){const k=h,D=$,c=g(null);let m=null,C=null;const p=async()=>{if(c.value)try{window._AMapSecurityConfig={securityJsCode:"a3ae5b960f3ed908393672ac36fc7bf1"};const u=await ke.load({key:"d7dd3eae862ecc57ed11d6f603358601",version:"2.0",plugins:["AMap.ToolBar","AMap.Scale","AMap.Geolocation","AMap.Geocoder"],AMapUI:{version:"1.1",plugins:[]}});m=new u.Map(c.value,{zoom:k.initialZoom||11,center:k.initialCenter||[116.397428,39.90923],viewMode:"3D",pitch:30}),m.addControl(new u.ToolBar),m.addControl(new u.Scale),C=new u.Geocoder({city:"010",radius:1e3}),D("map-ready",m),U(),k.autoLocate&&M(u)}catch(u){console.error("地图初始化失败:",u)}},U=()=>{!m||!C||m.on("click",u=>{const v=u.lnglat;C.getAddress(v,(b,l)=>{if(b==="complete"&&l.regeocode){const x={lnglat:v,longitude:v.getLng(),latitude:v.getLat(),address:l.regeocode.formattedAddress,addressComponent:l.regeocode.addressComponent,pois:l.regeocode.pois||[],businessAreas:l.regeocode.businessAreas||[]};console.log("点击位置信息:",x),D("poi-click",x)}else console.error("根据经纬度查询地址失败:",l)})})},M=u=>{const v=new u.Geolocation({enableHighAccuracy:!0,timeout:1e4,buttonOffset:new u.Pixel(10,20),zoomToAccuracy:!0});m.addControl(v),v.getCurrentPosition(),v.on("complete",b=>{console.log("定位成功:",b)}),v.on("error",b=>{console.error("定位失败:",b)})};return G(()=>{p()}),_e(()=>{m&&(m.destroy(),m=null),C=null}),(u,v)=>(E(),j("div",Pe,[i("div",{ref_key:"mapContainer",ref:c,class:"map-container"},null,512)]))}});const Re=ee(Fe,[["__scopeId","data-v-8fc091db"]]);function Te(h){return I({url:"/v1/facilities/list",method:"get",params:h})}function De(h){return I({url:`/v1/facilities/${h}`,method:"get"})}function Le(h){return I({url:"/v1/facilities/upload",method:"post",data:h})}function We(h){return I({url:`/v1/facilities/${h}`,method:"delete"})}const Be={class:"facility-container"},Ee={class:"header-section"},Ie={class:"header-menu"},$e={class:"menu-buttons"},Oe={class:"filter-section"},Ve={class:"filter-content"},qe={class:"filter-item"},Ge={class:"filter-item"},je={class:"filter-item"},He={class:"filter-item"},Ke={class:"filter-item"},Qe={class:"filter-actions"},Ze={class:"content-section"},Je={class:"content-wrapper"},Xe={class:"table-container"},Ye={class:"table-header"},et={class:"table-wrapper"},tt={class:"pagination-wrapper"},lt={class:"total-count"},at={style:{padding:"20px 0"}},it={style:{"font-size":"48px",color:"#999","margin-bottom":"8px"}},st={style:{display:"flex",gap:"8px",width:"100%"}},ot={key:0,style:{"margin-top":"8px","font-size":"12px",color:"#999"}},nt={class:"map-picker-content"},rt={class:"map-wrapper"},dt={class:"map-info-bar"},ct={class:"info-item"},ut={class:"info-value"},pt={class:"info-item"},ft={class:"info-value"},gt={class:"info-item full-width"},vt={class:"info-value"},mt={class:"map-modal-footer"},yt=q({__name:"index",setup(h){const $=q({props:{iconUrl:{type:String,required:!0}},setup(t){const e=g(""),a=g(!0),d=async()=>{if(!t.iconUrl||t.iconUrl.startsWith("ri:")){a.value=!1;return}try{let n="";if(t.iconUrl.startsWith("http://")||t.iconUrl.startsWith("https://")?n=new URL(t.iconUrl).pathname.substring(1):n=t.iconUrl.startsWith("/")?t.iconUrl.substring(1):t.iconUrl,n.includes("?")&&(n=n.split("?")[0]),n.includes("#")&&(n=n.split("#")[0]),n){const S=await X([{file_path:n}]);S.success&&S.data&&S.data.length>0?e.value=S.data[0].url:e.value=t.iconUrl}else e.value=t.iconUrl}catch(n){console.error("获取图标预览URL失败:",n),e.value=t.iconUrl}finally{a.value=!1}};return G(()=>{d()}),()=>a.value?y("div",{style:"width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;"},"..."):y("img",{src:e.value||t.iconUrl,style:"width: 32px; height: 32px; object-fit: cover; border-radius: 4px;",alt:"",onError:()=>{e.value=""}})}}),k=g("list"),D=t=>{k.value=t},c=V({deviceCode:null,deviceName:null,status:null,deviceType:null,updateTime:null}),m=g([{label:"全部状态",value:null},{label:"正常",value:"正常"},{label:"维修",value:"维修"},{label:"暂停",value:"暂停"},{label:"已拆除",value:"已拆除"}]),C=g([{label:"全部类型",value:null},{label:"洗手间",value:"洗手间"},{label:"儿童乐园",value:"儿童乐园"},{label:"休息区",value:"休息区"},{label:"轮椅通道",value:"轮椅通道"},{label:"互动体验",value:"互动体验"},{label:"便民点",value:"便民点"},{label:"避难点",value:"避难点"},{label:"风景名胜",value:"风景名胜"},{label:"紧急出口",value:"紧急出口"}]),p=he(),U=g(!1),M=g(!1),u=g(!1),v=g(""),b=g(null),l=V({facility_id:"",facility_name:"",category:"",icon:[],position_desc:"",longitude:null,latitude:null,status:"正常"}),x=g(!1);let z=null,_=null;const te={facility_name:[{required:!0,message:"请输入设备名称",trigger:"blur"}],category:[{required:!0,message:"请选择分类",trigger:"change"}],position_desc:[{required:!0,message:"请选择位置",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"change"}]},le=t=>{l.icon=t.fileList},ae=t=>t.type.startsWith("image/")?t.size/1024/1024<2?!0:(p.error("图片大小不能超过 2MB"),!1):(p.error("只能上传图片文件"),!1),ie=()=>{f.page=1,N()},se=()=>{c.deviceCode=null,c.deviceName=null,c.status=null,c.deviceType=null,c.updateTime=null,f.page=1,N()},H=g([]),K=g([]),oe={正常:{label:"正常",color:"#1890ff"},维修:{label:"维修",color:"#faad14"},暂停:{label:"暂停",color:"#ff4d4f"},已拆除:{label:"已拆除",color:"#999"}},ne=g((()=>[{type:"selection"},{title:"设备编码",key:"facility_id",width:150},{title:"设备名称",key:"facility_name",width:180},{title:"分类",key:"category",width:120},{title:"图标",key:"icon",width:80,render:t=>t.icon&&t.icon.startsWith("ri:")?y(A,{icon:t.icon,style:"font-size: 20px; color: #1890ff;"}):t.icon?y($,{iconUrl:t.icon}):y("span",{style:"color: #999; font-size: 12px;"},"无")},{title:"位置",key:"position_desc",width:200,ellipsis:{tooltip:!0}},{title:"状态",key:"status",width:100,render:t=>{const e=oe[t.status]||{label:t.status,color:"#999"};return y("div",{class:"status-cell",style:"display: inline-flex; align-items: center; gap: 6px;"},[y("span",{class:"status-dot",style:{width:"8px",height:"8px",minWidth:"8px",minHeight:"8px",borderRadius:"50%",display:"inline-block",flexShrink:"0",backgroundColor:e.color}}),y("span",{class:"status-text",style:"font-size: 14px; color: #333;"},e.label)])}},{title:"更新时间",key:"updated_at",width:180,render:t=>new Date(t.updated_at).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})},{title:"操作",key:"actions",width:150,render:t=>y("div",{class:"action-cell",style:"display: inline-flex; align-items: center; gap: 8px;"},[y("span",{class:"action-link edit",style:{fontSize:"14px",color:"#1890ff",cursor:"pointer"},onClick:()=>ue(t)},"编辑"),y("span",{class:"action-divider",style:{color:"#d9d9d9"}},"|"),y("span",{class:"action-link delete",style:{fontSize:"14px",color:"#ff4d4f",cursor:"pointer"},onClick:()=>pe(t.facility_id)},"删除")])}])()),f=V({page:1,pageSize:10,itemCount:0,pageSizes:[10,20,30,50],showSizePicker:!0,onUpdatePage:t=>{f.page=t,N()},onUpdatePageSize:t=>{f.pageSize=t,f.page=1,N()}}),N=async()=>{try{U.value=!0;const t=await Te({facility_id:c.deviceCode||void 0,facility_name:c.deviceName||void 0,category:c.deviceType||void 0,status:c.status||void 0,page:f.page,page_size:f.pageSize});t.success?(H.value=t.data||[],f.itemCount=t.total||0):p.error(t.message||"获取设备列表失败")}catch(t){console.error("获取设备列表失败:",t),p.error(t.message||"获取设备列表失败")}finally{U.value=!1}},re=()=>{u.value=!1,v.value="",l.facility_id=`FAC${Date.now().toString().slice(-8)}`,l.facility_name="",l.category="",l.icon=[],l.position_desc="",l.longitude=null,l.latitude=null,l.status="正常",M.value=!0,setTimeout(()=>{var t;(t=b.value)==null||t.restoreValidation()},0)},de=()=>new Promise((t,e)=>{var a;(a=b.value)==null||a.validate(async d=>{if(d){console.log("表单验证失败:",d),e(d);return}try{U.value=!0;let n="ri:building-line";if(l.icon&&l.icon.length>0){const L=l.icon[0];if(L.url&&L.url.startsWith("http"))n=L.url;else if(L.file)try{const w=await Ce(L.file,"image","facility/icons",!0);if(w.success&&w.data)n=w.data.file_url;else{p.error(w.message||"图标上传失败"),e(new Error(w.message||"图标上传失败"));return}}catch(w){console.error("图标上传失败:",w),p.error(w.message||"图标上传失败"),e(w);return}}const S={facility_id:u.value?v.value:l.facility_id,facility_name:l.facility_name,category:l.category,icon:n,position_desc:l.position_desc,longitude:l.longitude,latitude:l.latitude,status:l.status},O=await Le(S);O.success?(p.success(u.value?"编辑设备成功":"新增设备成功"),N(),t()):(p.error(O.message||(u.value?"编辑设备失败":"新增设备失败")),e(new Error(O.message)))}catch(n){console.error("操作失败:",n),p.error(n.message||"操作失败"),e(n)}finally{U.value=!1}})}),ce=()=>{M.value=!1},ue=async t=>{try{const e=await De(t.facility_id);if(e){if(u.value=!0,v.value=t.facility_id,l.facility_id=e.facility_id||t.facility_id,l.facility_name=e.facility_name||t.facility_name,l.category=e.category||t.category,l.position_desc=e.position_desc||t.position_desc,l.longitude=e.longitude?parseFloat(e.longitude):null,l.latitude=e.latitude?parseFloat(e.latitude):null,l.status=e.status||t.status,e.icon||t.icon){const a=e.icon||t.icon;if(a&&!a.startsWith("ri:"))try{let d="";if(a.startsWith("http://")||a.startsWith("https://")?d=new URL(a).pathname.substring(1):d=a.startsWith("/")?a.substring(1):a,d.includes("?")&&(d=d.split("?")[0]),d.includes("#")&&(d=d.split("#")[0]),d){const n=await X([{file_path:d}]);n.success&&n.data&&n.data.length>0?l.icon=[{id:Date.now().toString(),name:"icon.png",status:"finished",url:n.data[0].url}]:l.icon=[{id:Date.now().toString(),name:"icon.png",status:"finished",url:a}]}else l.icon=[{id:Date.now().toString(),name:"icon.png",status:"finished",url:a}]}catch(d){console.error("获取图标预览URL失败:",d),l.icon=[{id:Date.now().toString(),name:"icon.png",status:"finished",url:a}]}else l.icon=[]}else l.icon=[];M.value=!0,setTimeout(()=>{var a;(a=b.value)==null||a.restoreValidation()},0)}else p.error("获取设备详情失败")}catch(e){console.error("获取设备详情失败:",e),p.error(e.message||"获取设备详情失败")}},pe=async t=>{try{const e=await We(t);e.success?(p.success("删除成功"),N()):p.error(e.message||"删除失败")}catch(e){console.error("删除失败:",e),p.error(e.message||"删除失败")}},fe=()=>{x.value=!0},ge=t=>{if(z=t,l.longitude&&l.latitude){const e=window.AMap;e&&(_=new e.Marker({position:[l.longitude,l.latitude],draggable:!0}),_.setMap(t),t.setCenter([l.longitude,l.latitude]),_.on("dragend",a=>{const d=a.lnglat||a.target.getPosition();t.emit("click",{lnglat:d})}))}},ve=t=>{l.longitude=t.longitude,l.latitude=t.latitude,l.position_desc=t.address;const e=window.AMap;e&&z&&(_?_.setPosition([t.longitude,t.latitude]):(_=new e.Marker({position:[t.longitude,t.latitude],draggable:!0}),_.setMap(z),_.on("dragend",a=>{const d=a.lnglat||a.target.getPosition();z.emit("click",{lnglat:d})})),z.setCenter([t.longitude,t.latitude]))},me=()=>{if(!l.longitude||!l.latitude){p.warning("请在地图上选择位置");return}x.value=!1,p.success("位置选择成功")},ye=()=>{x.value=!1,_&&z&&(z.remove(_),_=null)};return G(()=>{N()}),(t,e)=>(E(),j("div",Be,[s(o(we),{"has-sider":"",class:"h-full w-full"},{default:r(()=>[s(o(be),{class:"h-full flex flex-col"},{default:r(()=>[i("div",Ee,[e[18]||(e[18]=i("div",{class:"header-title"},"设施设备管理",-1)),i("div",Ie,[i("div",$e,[i("span",{onClick:e[0]||(e[0]=a=>D("list")),class:Q(["menu-button",{"menu-button-active":k.value==="list"}])}," 设施设备列表 ",2),i("span",{onClick:e[1]||(e[1]=a=>D("location")),class:Q(["menu-button",{"menu-button-active":k.value==="location"}])}," 位置打点 ",2)])]),e[19]||(e[19]=i("div",{class:"header-placeholder"},null,-1))]),i("div",Oe,[i("div",Ve,[s(o(Y),{size:16,align:"center",wrap:""},{default:r(()=>[i("div",qe,[e[20]||(e[20]=i("span",{class:"filter-label"},"设备编码：",-1)),s(o(W),{value:c.deviceCode,"onUpdate:value":e[2]||(e[2]=a=>c.deviceCode=a),placeholder:"请输入设备编码",clearable:"",style:{width:"180px"}},null,8,["value"])]),i("div",Ge,[e[21]||(e[21]=i("span",{class:"filter-label"},"设备名称：",-1)),s(o(W),{value:c.deviceName,"onUpdate:value":e[3]||(e[3]=a=>c.deviceName=a),placeholder:"请输入设备名称",clearable:"",style:{width:"180px"}},null,8,["value"])]),i("div",je,[e[22]||(e[22]=i("span",{class:"filter-label"},"状态：",-1)),s(o(B),{value:c.status,"onUpdate:value":e[4]||(e[4]=a=>c.status=a),options:m.value,placeholder:"请选择状态",clearable:"",style:{width:"180px"}},null,8,["value","options"])]),i("div",He,[e[23]||(e[23]=i("span",{class:"filter-label"},"设备类型：",-1)),s(o(B),{value:c.deviceType,"onUpdate:value":e[5]||(e[5]=a=>c.deviceType=a),options:C.value,placeholder:"请选择设备类型",clearable:"",style:{width:"180px"}},null,8,["value","options"])]),i("div",Ke,[e[24]||(e[24]=i("span",{class:"filter-label"},"更新时间：",-1)),s(o(ze),{value:c.updateTime,"onUpdate:value":e[6]||(e[6]=a=>c.updateTime=a),type:"datetimerange",placeholder:"请选择更新时间",clearable:"",style:{width:"400px"}},null,8,["value"])])]),_:1})]),e[27]||(e[27]=i("div",{class:"filter-divider"},null,-1)),i("div",Qe,[s(o(Y),{size:12,vertical:""},{default:r(()=>[s(o(P),{type:"primary",class:"filter-btn",onClick:ie},{icon:r(()=>[s(o(A),{icon:"ri:search-line"})]),default:r(()=>[e[25]||(e[25]=F(" 查询 ",-1))]),_:1}),s(o(P),{class:"reset-btn",onClick:se},{icon:r(()=>[s(o(A),{icon:"ri:refresh-line"})]),default:r(()=>[e[26]||(e[26]=F(" 重置 ",-1))]),_:1})]),_:1})])]),i("div",Ze,[i("div",Je,[i("div",Xe,[i("div",Ye,[s(o(P),{type:"primary",class:"add-btn",onClick:re},{icon:r(()=>[s(o(A),{icon:"ri:add-line"})]),default:r(()=>[e[28]||(e[28]=F(" 新增设备 ",-1))]),_:1})]),i("div",et,[s(o(Ne),{columns:ne.value,data:H.value,loading:U.value,pagination:!1,"row-key":a=>a.facility_id,"checked-row-keys":K.value,"onUpdate:checkedRowKeys":e[7]||(e[7]=a=>K.value=a),striped:""},null,8,["columns","data","loading","row-key","checked-row-keys"])]),i("div",tt,[i("span",lt,"共 "+R(f.itemCount)+" 条",1),s(o(Se),{page:f.page,"onUpdate:page":[e[8]||(e[8]=a=>f.page=a),f.onUpdatePage],"page-size":f.pageSize,"onUpdate:pageSize":[e[9]||(e[9]=a=>f.pageSize=a),f.onUpdatePageSize],"item-count":f.itemCount,"page-sizes":f.pageSizes,"show-size-picker":""},null,8,["page","page-size","item-count","page-sizes","onUpdate:page","onUpdate:pageSize"])])])])])]),_:1})]),_:1}),s(o(J),{show:M.value,"onUpdate:show":e[16]||(e[16]=a=>M.value=a),"show-icon":!1,preset:"dialog",title:u.value?"编辑设备":"新增设备","positive-text":"确定","negative-text":"取消",onPositiveClick:de,onNegativeClick:ce,style:{width:"600px"},class:"add-device-modal"},{default:r(()=>[s(o(Ae),{ref_key:"addFormRef",ref:b,model:l,rules:te,"label-placement":"left","label-width":"100px"},{default:r(()=>[u.value?Z("",!0):(E(),xe(o(T),{key:0,label:"设备编码",path:"facility_id"},{default:r(()=>[s(o(W),{value:l.facility_id,"onUpdate:value":e[10]||(e[10]=a=>l.facility_id=a),placeholder:"自动生成",disabled:""},null,8,["value"])]),_:1})),s(o(T),{label:"设备名称",path:"facility_name"},{default:r(()=>[s(o(W),{value:l.facility_name,"onUpdate:value":e[11]||(e[11]=a=>l.facility_name=a),placeholder:"请输入设备名称",clearable:""},null,8,["value"])]),_:1}),s(o(T),{label:"分类",path:"category"},{default:r(()=>[s(o(B),{value:l.category,"onUpdate:value":e[12]||(e[12]=a=>l.category=a),options:C.value.filter(a=>a.value!==null),placeholder:"请选择分类",clearable:""},null,8,["value","options"])]),_:1}),s(o(T),{label:"图标",path:"icon"},{default:r(()=>[s(o(Ue),{"file-list":l.icon,"onUpdate:fileList":e[13]||(e[13]=a=>l.icon=a),max:1,"before-upload":ae,"list-type":"image-card",accept:"image/*",onChange:le},{default:r(()=>[s(o(Me),null,{default:r(()=>[i("div",at,[i("div",it,[s(o(A),{icon:"ri:upload-cloud-line"})]),e[29]||(e[29]=i("div",{style:{"font-size":"12px",color:"#999","margin-top":"4px"}},"上传图标（可选）",-1))])]),_:1})]),_:1},8,["file-list"])]),_:1}),s(o(T),{label:"位置",path:"position_desc"},{default:r(()=>[i("div",st,[s(o(W),{value:l.position_desc,"onUpdate:value":e[14]||(e[14]=a=>l.position_desc=a),placeholder:"点击右侧按钮在地图上选择位置",readonly:"",style:{flex:"1"}},null,8,["value"]),s(o(P),{type:"primary",onClick:fe},{icon:r(()=>[s(o(A),{icon:"ri:map-pin-line"})]),default:r(()=>[e[30]||(e[30]=F(" 选择 ",-1))]),_:1})]),l.longitude&&l.latitude?(E(),j("div",ot," 经度: "+R(l.longitude.toFixed(6))+", 纬度: "+R(l.latitude.toFixed(6)),1)):Z("",!0)]),_:1}),s(o(T),{label:"状态",path:"status"},{default:r(()=>[s(o(B),{value:l.status,"onUpdate:value":e[15]||(e[15]=a=>l.status=a),options:m.value.filter(a=>a.value!==null),placeholder:"请选择状态",clearable:""},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),s(o(J),{show:x.value,"onUpdate:show":e[17]||(e[17]=a=>x.value=a),"show-icon":!1,preset:"card",title:"选择位置",style:{width:"900px",height:"700px"},class:"map-picker-modal"},{footer:r(()=>[i("div",mt,[s(o(P),{onClick:ye},{default:r(()=>[...e[35]||(e[35]=[F("取消",-1)])]),_:1}),s(o(P),{type:"primary",onClick:me},{default:r(()=>[...e[36]||(e[36]=[F("确定",-1)])]),_:1})])]),default:r(()=>{var a,d;return[i("div",nt,[i("div",rt,[s(Re,{"initial-center":l.longitude&&l.latitude?[l.longitude,l.latitude]:void 0,"initial-zoom":15,onMapReady:ge,onPoiClick:ve},null,8,["initial-center"])]),i("div",dt,[i("div",ct,[e[31]||(e[31]=i("span",{class:"info-label"},"经度：",-1)),i("span",ut,R(((a=l.longitude)==null?void 0:a.toFixed(6))||"-"),1)]),i("div",pt,[e[32]||(e[32]=i("span",{class:"info-label"},"纬度：",-1)),i("span",ft,R(((d=l.latitude)==null?void 0:d.toFixed(6))||"-"),1)]),i("div",gt,[e[33]||(e[33]=i("span",{class:"info-label"},"地址：",-1)),i("span",vt,R(l.position_desc||"请在地图上点击选择位置"),1)])]),e[34]||(e[34]=i("div",{class:"map-tip"}," 提示：点击地图或拖动标记选择位置 ",-1))])]}),_:1},8,["show"])]))}});const At=ee(yt,[["__scopeId","data-v-8a06f05d"]]);export{At as default};

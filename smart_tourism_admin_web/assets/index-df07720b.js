import{b9 as k,d as Y,a2 as Z,r as p,bS as C,a4 as N,$ as ee,o as te,c as le,a as s,b as o,ab as u,R as n,a6 as F,w as c,ah as b,al as ae,N as ie,aS as U,a5 as I,ac as L,ad as se,b6 as oe}from"./index-fc2ca07d.js";import{N as ne}from"./DataTable-2e69da2a.js";import{N as re}from"./Pagination-078592c4.js";import{N as de}from"./Form-97fa87e1.js";import{N as P}from"./FormItem-9918da75.js";import{N as ce}from"./Upload-7895b36e.js";import"./Forward-86f34074.js";function ue(g){return k({url:"/api/v1/cultural-heritage/list",method:"get",params:g})}function pe(g){return k({url:`/api/v1/cultural-heritage/${g}`,method:"get"})}function fe(g){return k({url:"/api/v1/cultural-heritage/upload",method:"post",data:g})}function E(g){return k({url:`/api/v1/cultural-heritage/${g}`,method:"delete"})}const ge={class:"archive-container"},me={class:"h-full flex flex-col"},ve={class:"filter-section"},_e={class:"filter-content"},ye={class:"filter-left"},he={class:"filter-item"},we={class:"filter-item"},xe={class:"filter-item"},be={class:"filter-right"},ke={class:"content-section"},ze={class:"content-wrapper"},Se={class:"table-container"},Ce={class:"table-wrapper"},Ne={class:"pagination-wrapper"},Ue={class:"total-count"},$e={style:{"margin-left":"8px"}},Me=Y({__name:"index",setup(g){const r=Z(),z=p(!1),d=C({keyword:"",tag:null,file_type:null}),$=p([{label:"全部标签",value:null},{label:"非遗",value:"非遗"},{label:"古建",value:"古建"},{label:"民俗",value:"民俗"},{label:"文献",value:"文献"}]),T=p([{label:"全部类型",value:null},{label:"文件",value:"文件"},{label:"图片",value:"图片"},{label:"视频",value:"视频"}]),H={非遗:"error",古建:"success",民俗:"warning",文献:"info"},R={图片:{icon:"ri:image-line",color:"#ff9800"},文件:{icon:"ri:file-text-line",color:"#2196f3"},视频:{icon:"ri:video-line",color:"#f44336"}},M=p([]),D=p([]),h=p(!1),w=p(null),_=p(!1),x=p(""),a=C({file_name:"",file_type:"文件",tag:"非遗",url:"",files:[]}),V={tag:[{required:!0,message:"请选择所属标签",trigger:"change"}],files:[{required:!0,message:"请上传文件",trigger:"change",validator:(t,e)=>!e||e.length===0?new Error("请上传文件"):!0}]},B=p((()=>[{type:"selection"},{title:"文件名称",key:"file_name",width:300,render:t=>{const e=R[t.file_type]||{icon:"ri:file-line",color:"#666"};return c("div",{style:"display: flex; align-items: center; gap: 8px;"},[c("div",{style:`
                  width: 32px;
                  height: 32px;
                  background-color: ${e.color}20;
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  flex-shrink: 0;
                `},[c(b,{icon:e.icon,style:`color: ${e.color}; font-size: 18px;`})]),c("span",{style:"overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"},t.file_name)])}},{title:"文件类型",key:"file_type",width:120},{title:"所属标签",key:"tag",width:200,render:t=>{const e=t.tag?t.tag.split(",").map(l=>l.trim()):[];return c("div",{style:"display: flex; gap: 4px; flex-wrap: wrap;"},e.map(l=>c(ae,{type:H[l]||"default",size:"small"},{default:()=>l})))}},{title:"上传时间",key:"created_at",width:180,render:t=>t.created_at?new Date(t.created_at).toLocaleString("zh-CN"):"-"},{title:"操作",key:"actions",width:200,fixed:"right",render:t=>c("div",{class:"action-cell",style:"display: inline-flex; align-items: center; gap: 8px;"},[c("span",{class:"action-link edit",style:{fontSize:"14px",color:"#1890ff",cursor:"pointer"},onClick:()=>j(t)},"编辑"),c("span",{class:"action-divider",style:{color:"#d9d9d9"}},"|"),c("span",{class:"action-link history",style:{fontSize:"14px",color:"#1890ff",cursor:"pointer"},onClick:()=>G(t)},"历史版本"),c("span",{class:"action-divider",style:{color:"#d9d9d9"}},"|"),c("span",{class:"action-link delete",style:{fontSize:"14px",color:"#ff4d4f",cursor:"pointer"},onClick:()=>J(t.file_id)},"删除")])}])()),i=C({page:1,pageSize:10,itemCount:0,pageSizes:[10,20,30,50],showSizePicker:!0,onUpdatePage:t=>{i.page=t,m()},onUpdatePageSize:t=>{i.pageSize=t,i.page=1,m()}}),m=async()=>{try{z.value=!0;const t=await ue({file_name:d.keyword||void 0,tag:d.tag||void 0,file_type:d.file_type||void 0,page:i.page,page_size:i.pageSize});t.success?(M.value=t.data||[],i.itemCount=t.total||0):r.error(t.message||"获取数据失败")}catch(t){console.error("获取数据失败:",t),r.error(t.message||"获取数据失败")}finally{z.value=!1}};N(()=>d.keyword,()=>{i.page=1,m()}),N(()=>d.tag,()=>{i.page=1,m()}),N(()=>d.file_type,()=>{i.page=1,m()});const q=()=>{_.value=!1,x.value="",a.tag="非遗",a.files=[],a.file_name="",a.file_type="文件",a.url="",h.value=!0,setTimeout(()=>{var t;(t=w.value)==null||t.restoreValidation()},0)},A=t=>{var e;if(a.files=t.fileList,t.fileList.length>0){const l=t.fileList[0],v=l.file;if(v){a.file_name=l.name||v.name||"";const f=l.name||v.name||"",y=((e=f.split(".").pop())==null?void 0:e.toLowerCase())||"";["jpg","jpeg","png","gif","bmp","webp","svg"].includes(y)?a.file_type="图片":["mp4","avi","mov","wmv","flv","mkv","webm"].includes(y)?a.file_type="视频":a.file_type="文件",a.url=l.url||`https://example.com/files/${f}`}}},O=t=>{const e=t.file.file;return e?e.size/1024/1024<50?!0:(r.error("文件大小不能超过 50MB"),!1):!0},K=()=>new Promise((t,e)=>{var l;(l=w.value)==null||l.validate(async v=>{if(v){console.log("表单验证失败:",v),e(v);return}if(!a.files||a.files.length===0){r.error("请上传文件"),e(new Error("请上传文件"));return}try{_.value&&await E(x.value);const f=a.files[0],y=a.file_name||f.name||"",Q=a.file_type||"文件",W=a.url||f.url||`https://example.com/files/${y}`,X={file_id:_.value?x.value:`FH${Date.now()}${Math.random().toString(36).substr(2,9)}`,file_name:y,file_type:Q,tag:a.tag,url:W},S=await fe(X);S.success?(r.success(_.value?"编辑成功":"新增成功"),m(),t()):(r.error(S.message||"操作失败"),e(new Error(S.message||"操作失败")))}catch(f){console.error("操作失败:",f),r.error(f.message||"操作失败"),e(f)}})}),j=async t=>{try{const e=await pe(t.file_id);e?(_.value=!0,x.value=t.file_id,a.file_name=e.file_name||t.file_name,a.file_type=e.file_type||t.file_type,a.tag=e.tag||t.tag,a.url=e.url||t.url,a.files=[],h.value=!0,setTimeout(()=>{var l;(l=w.value)==null||l.restoreValidation()},0)):r.error(e.message||"获取详情失败")}catch(e){console.error("获取详情失败:",e),r.error(e.message||"获取详情失败")}},G=t=>{r.info(`查看 ${t.file_name} 的历史版本`)},J=async t=>{try{const e=await E(t);e.success?(r.success("删除成功"),m()):r.error(e.message||"删除失败")}catch(e){console.error("删除失败:",e),r.error(e.message||"删除失败")}};return ee(()=>{m()}),(t,e)=>(te(),le("div",ge,[s("div",me,[e[10]||(e[10]=s("div",{class:"header-section"},[s("div",{class:"header-title"},"文化遗产数字化档案管理"),s("div",{class:"header-placeholder"})],-1)),s("div",ve,[s("div",_e,[s("div",ye,[s("div",he,[o(n(ie),{value:d.keyword,"onUpdate:value":e[0]||(e[0]=l=>d.keyword=l),placeholder:"搜索关键词",clearable:"",style:{width:"220px"}},{suffix:u(()=>[o(n(b),{icon:"ri:search-line"})]),_:1},8,["value"])]),s("div",we,[o(n(U),{value:d.tag,"onUpdate:value":e[1]||(e[1]=l=>d.tag=l),options:$.value,placeholder:"所属标签",clearable:"",style:{width:"180px"}},null,8,["value","options"])]),s("div",xe,[o(n(U),{value:d.file_type,"onUpdate:value":e[2]||(e[2]=l=>d.file_type=l),options:T.value,placeholder:"文件类型",clearable:"",style:{width:"180px"}},null,8,["value","options"])])]),s("div",be,[o(n(L),{type:"primary",onClick:q},{icon:u(()=>[o(n(b),{icon:"ri:add-line"})]),default:u(()=>[e[9]||(e[9]=I(" 新增档案 "))]),_:1})])])]),s("div",ke,[s("div",ze,[s("div",Se,[s("div",Ce,[o(n(ne),{columns:B.value,data:M.value,pagination:!1,"row-key":l=>l.file_id,"checked-row-keys":D.value,"onUpdate:checkedRowKeys":e[3]||(e[3]=l=>D.value=l),loading:z.value,striped:""},null,8,["columns","data","row-key","checked-row-keys","loading"])]),s("div",Ne,[s("span",Ue,"共"+F(i.itemCount)+"条",1),o(n(re),{page:i.page,"onUpdate:page":[e[4]||(e[4]=l=>i.page=l),i.onUpdatePage],"page-size":i.pageSize,"onUpdate:pageSize":[e[5]||(e[5]=l=>i.pageSize=l),i.onUpdatePageSize],"item-count":i.itemCount,"page-sizes":i.pageSizes,"show-size-picker":"","page-slot":7},{suffix:u(()=>[s("span",$e,F(i.pageSize)+"条/页",1)]),_:1},8,["page","page-size","item-count","page-sizes","onUpdate:page","onUpdate:pageSize"])])])])])]),o(n(se),{show:h.value,"onUpdate:show":e[8]||(e[8]=l=>h.value=l),"show-icon":!1,preset:"dialog",title:_.value?"编辑档案":"新增档案","positive-text":"提交","negative-text":"取消",onPositiveClick:K,style:{width:"600px"},class:"archive-modal"},{default:u(()=>[o(n(de),{ref_key:"addFormRef",ref:w,model:a,rules:V,"label-placement":"top"},{default:u(()=>[o(n(P),{label:"所属标签",path:"tag"},{default:u(()=>[o(n(U),{value:a.tag,"onUpdate:value":e[6]||(e[6]=l=>a.tag=l),options:$.value.filter(l=>l.value!==null),placeholder:"请选择所属标签"},null,8,["value","options"])]),_:1}),o(n(P),{label:"文件",path:"files"},{default:u(()=>[o(n(ce),{"file-list":a.files,"onUpdate:fileList":e[7]||(e[7]=l=>a.files=l),max:1,"before-upload":O,onChange:A,"default-upload":!1,"list-type":"text"},{default:u(()=>[o(n(L),{text:"",type:"info"},{icon:u(()=>[o(n(b),{icon:"ri:upload-cloud-line"})]),default:u(()=>[e[11]||(e[11]=I(" 点击上传文件 "))]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])]))}});const Ve=oe(Me,[["__scopeId","data-v-f077e48c"]]);export{Ve as default};
